<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar@0.2.2/src/L.Control.Sidebar.css" crossorigin="" />

<style>
  body {
    margin: 0;
  }

  #map {
    width: 960px;
    height: 640px;
    transform: translate(-50%,-50%);
    position: absolute;
    top: 50%;
    left: 50%;
  }

  .leaflet-sidebar {
    display: none;
    width: 200px;
  }

  .leaflet-sidebar.visible {
    display: block;
  }

  .leaflet-sidebar .close {
    z-index: 10000;
  }

  .leaflet-marker-icon.marker-cluster {
    line-height: 18px;
    text-align: center;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    background: #fff;
    border: 2px solid #222;
  }
</style>

<div id="map"></div>
<div id="sidebar"></div>

<script>
  var geoJson = []
  var organisations = [{"organisation":"local-authority-eng:SAL","wikidata":"Q7592257","name":"St Albans City and District Council","website":"https://www.stalbans.gov.uk","twitter":"","statistical-geography":"E07000100","toid":"","opendatacommunities":"http://opendatacommunities.org/id/district-council/st-albans","opendatacommunities-area":"http://opendatacommunities.org/id/geography/administration/nmd/E07000240","billing-authority":"E1936","census-area":"26UG","local-authority-type":"NMD","esd-inventories":"","start-date":"1974-04-01","end-date":""}]
  var brownfield = [{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"298","site-address":"Pan Autos and adjacent uses Dark Lane and Grove Road","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=514533&y=213352&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.806617","longitude":"-0.338574","hectares":"0.35","minimum-net-dwellings":"12","maximum-net-dwellings":"12","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"299","site-address":"Jewsons Dark Lane","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=514483&y=213364&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.806736","longitude":"-0.339303","hectares":"0.34","minimum-net-dwellings":"18","maximum-net-dwellings":"18","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"331","site-address":"The Red House Harpenden Memorial Hospital","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=513618&y=214637&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.818349","longitude":"-0.351426","hectares":"1.63","minimum-net-dwellings":"55","maximum-net-dwellings":"55","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"235","site-address":"72 High Street","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=518008&y=203955&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.721429","longitude":"-0.291398","hectares":"0.66","minimum-net-dwellings":"6","maximum-net-dwellings":"6","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"283","site-address":"Haseldine Road car park","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=517683&y=204048&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.722336","longitude":"-0.296072","hectares":"0.52","minimum-net-dwellings":"9","maximum-net-dwellings":"9","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"310","site-address":"Hertfordshire Business Centre Alexander Road","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=517798&y=204385&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.725333","longitude":"-0.294286","hectares":"0.28","minimum-net-dwellings":"45","maximum-net-dwellings":"45","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"80","site-address":"Sphere industrial estate","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=516429&y=206977&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.748925","longitude":"-0.313241","hectares":"1.35","minimum-net-dwellings":"120","maximum-net-dwellings":"120","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"81","site-address":"Morrisons car park","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=516561&y=207203&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.750921","longitude":"-0.311251","hectares":"1.65","minimum-net-dwellings":"76","maximum-net-dwellings":"76","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"83","site-address":"Abbey Station","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=514576&y=206387&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.744003","longitude":"-0.340263","hectares":"0.94","minimum-net-dwellings":"40","maximum-net-dwellings":"40","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"208","site-address":"Civic Centre","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=514989&y=207337&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.752458","longitude":"-0.333966","hectares":"0.43","minimum-net-dwellings":"70","maximum-net-dwellings":"70","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"210","site-address":"Griffiths Way","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=514686&y=206073&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.741155","longitude":"-0.338774","hectares":"8.52","minimum-net-dwellings":"100","maximum-net-dwellings":"100","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"227","site-address":"Jewson Depot","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=516955&y=207144&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.75031","longitude":"-0.305568","hectares":"0.44","minimum-net-dwellings":"20","maximum-net-dwellings":"20","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"251","site-address":"Civic Centre South","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=514928&y=207252&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.751702","longitude":"-0.334875","hectares":"0.88","minimum-net-dwellings":"100","maximum-net-dwellings":"100","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"256","site-address":"EMP9 (northern part) St Albans Road (adjacent to the Council depot)","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=515979&y=209314&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.770023","longitude":"-0.318976","hectares":"2.4","minimum-net-dwellings":"100","maximum-net-dwellings":"100","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"259","site-address":"Ariston Site (incl Pioneer Youth Club)","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=515112&y=208483&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.762732","longitude":"-0.33181","hectares":"2.63","minimum-net-dwellings":"55","maximum-net-dwellings":"55","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"260","site-address":"222 London Road","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=515535&y=206385&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.743781","longitude":"-0.326377","hectares":"0.66","minimum-net-dwellings":"22","maximum-net-dwellings":"22","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"264","site-address":"West of St Peters Street","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=514728&y=207437&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.753406","longitude":"-0.337717","hectares":"2.13","minimum-net-dwellings":"60","maximum-net-dwellings":"60","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"275","site-address":"Catherine Street","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=514879&y=207648&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.755276","longitude":"-0.335456","hectares":"0.81","minimum-net-dwellings":"30","maximum-net-dwellings":"30","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"281","site-address":"Ziggurat car park","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=515519&y=206595&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.745677","longitude":"-0.326534","hectares":"0.44","minimum-net-dwellings":"12","maximum-net-dwellings":"12","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"461","site-address":"Electricity Works Campfield Road","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=516339&y=206978&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.748947","longitude":"-0.314536","hectares":"0.66","minimum-net-dwellings":"25","maximum-net-dwellings":"25","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"478","site-address":"Land at the Hedges Woollam Crescent","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=514422&y=209239&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.769663","longitude":"-0.341553","hectares":"0.27","minimum-net-dwellings":"10","maximum-net-dwellings":"10","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"155","site-address":"Southern part of Murphys Chemicals Site Codicote Road","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=517912&y=214215&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.813664","longitude":"-0.289295","hectares":"0.81","minimum-net-dwellings":"18","maximum-net-dwellings":"18","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"},{"entry-date":"2017-05-23","organisation":"local-authority-eng:SAL","site":"Non SHLAA NS1","site-address":"Harpenden Public Hall","site-plan-url":"http://gis.stalbans.gov.uk/WebMapLayers8/map.aspx?x=513586&y=214125&resolution=0.1&epsg=27700&mapname=stalbans&baseLayer=Black%20and%20White%20Maps&datalayers=Brownfield%20Land%20Register%2CselectFeaturesControl_container","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.813751","longitude":"-0.352062","hectares":"0.47","minimum-net-dwellings":"18","maximum-net-dwellings":"18","start-date":"2017-02-07","end-date":"","notes":"","resource":"a8cc3bf15d26db7d4ee1d02078bec9529105da509d699f307d19b288bc9b9086"}]
</script>

<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-sidebar@0.2.2/src/L.Control.Sidebar.js" crossorigin=""></script>
<script src="https://unpkg.com/papaparse@5.1.1/papaparse.min.js" crossorigin=""></script>

<script>
var map = L.map('map', {
  preferCanvas: true,
  fullscreenControl: true
}).setView([52.561928, -1.464854], 7)

// Tile layers
L.tileLayer('https://tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
  id: 'base',
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map)

// Sidebar
var sidebar = L.control.sidebar('sidebar', {
  position: 'right'
})

map.addControl(sidebar)

// Brownfield Features
var brownfieldFeatures = brownfield.map(function (point) {
  return {
    type: 'Feature',
    geometry: {
      type: 'Point',
      coordinates: [point.longitude, point.latitude]
    },
    properties: point
  }
})

// Local authority boundaries (England only)
geoJson = geoJson.features.filter(function (item) {
  return item.properties.lad19cd.startsWith('E')
}).map(function (item) {
  var lad19cd = item.properties.lad19cd
  if (item.properties.lad19cd === 'E06000057') {
    // Northumberland
    lad19cd = 'E06000048'
  } else if (item.properties.lad19cd === 'E07000240') {
    // St Albans
    lad19cd = 'E07000100'
  } else if (item.properties.lad19cd === 'E07000241') {
    // Welwyn Hatfield
    lad19cd = 'E07000104'
  } else if (item.properties.lad19cd === 'E07000242') {
    // East Hertfordshire
    lad19cd = 'E07000097'
  } else if (item.properties.lad19cd === 'E07000243') {
    // Stevenage
    lad19cd = 'E07000101'
  } else if (item.properties.lad19cd === 'E08000037') {
    // Gateshead
    lad19cd = 'E08000020'
  }

  item.properties.organisation = organisations.find(function (organisation) {
    if (organisation['statistical-geography'] && organisation['statistical-geography'].length) {
      return organisation['statistical-geography'].toString().toLowerCase() === lad19cd.toString().toLowerCase()
    }
  })

  return item
})

L.geoJSON(geoJson, {
  style: {
    fillOpacity: 0,
    weight: 2,
    color: 'gray'
  },
  onEachFeature: function (feature, layer) {
    if(organisations.length === 1) {
      map.fitBounds(layer.getBounds())
    }

    if (!feature.properties.organisation) {
      layer.setStyle({
        fillColor: 'red',
        fillOpacity: 0.25
      })
    } else {
      var thisOrganisationsFeatures = brownfieldFeatures.filter(function (brownfieldFeature) {
        if (brownfieldFeature.properties.organisation.toLowerCase() === feature.properties.organisation.organisation.toLowerCase()) {
          return true
        }
        return false
      })

      var brownfieldMarkers = L.markerClusterGroup({
        showCoverageOnHover: false,
        zoomToBoundsOnClick: false,
        spiderfyOnMaxZoom: false,
        removeOutsideVisibleBounds: true,
        animate: false,
        disableClusteringAtZoom: 11,
        maxClusterRadius: 600,
        singleMarkerMode: false
      })
      var brownfieldOnMap = L.geoJSON({
        type: 'FeatureCollection',
        features: thisOrganisationsFeatures
      }, {
        pointToLayer: function (feature, latlng) {
          var size = isNaN(feature.properties.hectares) ? 100 : (Math.sqrt((feature.properties.hectares * 10000) / Math.PI))
          return L.circle(latlng, { color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: size.toFixed(2) })
        },
        onEachFeature: function (feature, layer) {
          layer.on({
            click: function () {
              sidebar.setContent('<h2>Loading...</h2>')
              sidebar.show()

              return Papa.parse('https://raw.githubusercontent.com/digital-land/map/master/docs/data/brownfield/' + feature.properties.organisation.toLowerCase().replace(':', '-') + '.csv', {
                download: true,
                header: true,
                complete: function (results) {
                  var point = results.data.find(function (row) {
                    return (row.latitude === feature.properties.latitude.toString()) && (row.longitude === feature.properties.longitude.toString())
                  })

                  if (point) {
                    content = ''

                    Object.keys(point).forEach(function (key) {
                      content = content + key + ': ' + point[key] + '<br>'
                    })
                  } else {
                    content = '<h2>Point not found - debug info:</h2><pre>' + JSON.stringify(results.data) + '</pre><h3>Looking for a row with latitude, longitude:</h3>' + feature.properties.latitude.toString() + ',' + feature.properties.longitude.toString()
                  }

                  sidebar.setContent(content)
                }
              })
            }
          })
        }
      })

      brownfieldMarkers.addLayer(brownfieldOnMap)
      map.addLayer(brownfieldMarkers)
    }

    layer.on({
      mouseover: function () {
        this.setStyle({
          fillColor: 'black',
          fillOpacity: 0.25
        })
      },
      mouseout: function () {
        this.setStyle({
          fillColor: 'white',
          fillOpacity: 0
        })
      },
      click: function () {
        return map.fitBounds(layer.getBounds())
      }
    })
  }
}).addTo(map)
</script>

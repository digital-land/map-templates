<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar@0.2.2/src/L.Control.Sidebar.css" crossorigin="" />

<style>
  body {
    margin: 0;
  }

  #map {
    width: 960px;
    height: 640px;
    transform: translate(-50%,-50%);
    position: absolute;
    top: 50%;
    left: 50%;
  }

  .leaflet-sidebar {
    display: none;
    width: 200px;
  }

  .leaflet-sidebar.visible {
    display: block;
  }

  .leaflet-sidebar .close {
    z-index: 10000;
  }

  .leaflet-marker-icon.marker-cluster {
    line-height: 18px;
    text-align: center;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    background: #fff;
    border: 2px solid #222;
  }
</style>

<div id="map"></div>
<div id="sidebar"></div>

<script>
  var geoJson = []
  var organisations = [{"organisation":"national-park-authority:Q72617669","wikidata":"Q72617669","name":"North York Moors National Park Authority","website":"https://www.gov.uk/government/organisations/north-york-moors-national-park","twitter":"northyorkmoors","statistical-geography":"E26000005","toid":"","opendatacommunities":"http://opendatacommunities.org/id/national-park-authority/north-york-moors","opendatacommunities-area":"http://opendatacommunities.org/id/geography/administration/npark/E26000005","billing-authority":"E6404","census-area":"","local-authority-type":"","esd-inventories":"","start-date":"","end-date":""}]
  var brownfield = [{"entry-date":"2018-12-17","organisation":"national-park-authority:Q72617669","site":"BR-001","site-address":"Former Primary School, Claver Close, Swainby","site-plan-url":"http://www.northyorkmoors.org.uk/planning/framework/brownfield-land-register/brownfield-land-register-map?inspect_query=brno&inspect_value=BR-001&show_viewfinder=true","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"54.409096","longitude":"-1.264784","hectares":"0.49","minimum-net-dwellings":"13","maximum-net-dwellings":"13","start-date":"2017-12-14","end-date":"","notes":". Former Primary School, Swainby, (no relevant planning history). 8 to 10 affordable dwellings in total, 2 or 3 bedroomed dwellings as an exceptions site (Core policy K of the LDF) with road frontages on to Claver Close and an area of open space in the southern area of the site to maintain the open character of the site.","resource":"c8f7273214684659af76edb9ff20dde82d191e11effdf9ea0024b319ca81de8d"},{"entry-date":"2018-12-17","organisation":"national-park-authority:Q72617669","site":"BR-002","site-address":"Former British Legion Club, High Street, Hinderwell","site-plan-url":"http://www.northyorkmoors.org.uk/planning/framework/brownfield-land-register/brownfield-land-register-map?inspect_query=brno&inspect_value=BR-002&show_viewfinder=true","deliverable":"","ownership":"","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"54.534216","longitude":"-0.776159","hectares":"0.4","minimum-net-dwellings":"8","maximum-net-dwellings":"8","start-date":"2017-12-14","end-date":"","notes":". Land between Station Road and Coronation Avenue, Hinderwell, (previous outline planning consent for residential development, 8 dwellings). 8 affordable dwellings in total, 2 and 3 bedroomed dwellings as an exceptions site (Core policy K of the LDF) with highway access from A174 only.","resource":"c8f7273214684659af76edb9ff20dde82d191e11effdf9ea0024b319ca81de8d"},{"entry-date":"2018-12-17","organisation":"national-park-authority:Q72617669","site":"BR-003","site-address":"Former NYCC Depot, West Ayton","site-plan-url":"http://www.northyorkmoors.org.uk/planning/framework/brownfield-land-register/brownfield-land-register-map?inspect_query=brno&inspect_value=BR-003&show_viewfinder=true","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"54.245064","longitude":"-0.490664","hectares":"0.72","minimum-net-dwellings":"10","maximum-net-dwellings":"10","start-date":"2017-12-14","end-date":"","notes":"Part of site within Scarborough Borough Council. Since planning permission site within the Conservation Area. Former NYCC Depot, West Ayton (previous outline planning consent for open market housing development with planning brief.) Site straddles the National Park boundary and being split between the National Park and Scarborough Borough Council. 10 open market dwellings in total on the whole site, two and three bedroomed dwellings. 40% affordable housing requirement under Core policy J of the LDF. Development to take account of planning brief and more recent Conservation Area status. Development will require the retention of the Station House/office, platform and Goods Warehouse.","resource":"c8f7273214684659af76edb9ff20dde82d191e11effdf9ea0024b319ca81de8d"},{"entry-date":"2018-12-17","organisation":"national-park-authority:Q72617669","site":"BR-004","site-address":"Blue Bank Garage, Coach Road, Sleights","site-plan-url":"http://www.northyorkmoors.org.uk/planning/framework/brownfield-land-register/brownfield-land-register-map?inspect_query=brno&inspect_value=BR-004&show_viewfinder=true","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"54.44901","longitude":"-0.665742","hectares":"0.26","minimum-net-dwellings":"4","maximum-net-dwellings":"4","start-date":"2018-11-29","end-date":"","notes":". Demolition of existing dwelling (No 171) and garage buildings and construction of 4 no dwellings with associated access, parking and landscaping works.","resource":"c8f7273214684659af76edb9ff20dde82d191e11effdf9ea0024b319ca81de8d"}]
</script>

<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-sidebar@0.2.2/src/L.Control.Sidebar.js" crossorigin=""></script>
<script src="https://unpkg.com/papaparse@5.1.1/papaparse.min.js" crossorigin=""></script>

<script>
var map = L.map('map', {
  preferCanvas: true,
  fullscreenControl: true
}).setView([52.561928, -1.464854], 7)

// Tile layers
L.tileLayer('https://tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
  id: 'base',
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map)

// Sidebar
var sidebar = L.control.sidebar('sidebar', {
  position: 'right'
})

map.addControl(sidebar)

// Brownfield Features
var brownfieldFeatures = brownfield.map(function (point) {
  return {
    type: 'Feature',
    geometry: {
      type: 'Point',
      coordinates: [point.longitude, point.latitude]
    },
    properties: point
  }
})

// Local authority boundaries (England only)
geoJson = geoJson.features.filter(function (item) {
  return item.properties.lad19cd.startsWith('E')
}).map(function (item) {
  var lad19cd = item.properties.lad19cd
  if (item.properties.lad19cd === 'E06000057') {
    // Northumberland
    lad19cd = 'E06000048'
  } else if (item.properties.lad19cd === 'E07000240') {
    // St Albans
    lad19cd = 'E07000100'
  } else if (item.properties.lad19cd === 'E07000241') {
    // Welwyn Hatfield
    lad19cd = 'E07000104'
  } else if (item.properties.lad19cd === 'E07000242') {
    // East Hertfordshire
    lad19cd = 'E07000097'
  } else if (item.properties.lad19cd === 'E07000243') {
    // Stevenage
    lad19cd = 'E07000101'
  } else if (item.properties.lad19cd === 'E08000037') {
    // Gateshead
    lad19cd = 'E08000020'
  }

  item.properties.organisation = organisations.find(function (organisation) {
    if (organisation['statistical-geography'] && organisation['statistical-geography'].length) {
      return organisation['statistical-geography'].toString().toLowerCase() === lad19cd.toString().toLowerCase()
    }
  })

  return item
})

L.geoJSON(geoJson, {
  style: {
    fillOpacity: 0,
    weight: 2,
    color: 'gray'
  },
  onEachFeature: function (feature, layer) {
    if(organisations.length === 1) {
      map.fitBounds(layer.getBounds())
    }

    if (!feature.properties.organisation) {
      layer.setStyle({
        fillColor: 'red',
        fillOpacity: 0.25
      })
    } else {
      var thisOrganisationsFeatures = brownfieldFeatures.filter(function (brownfieldFeature) {
        if (brownfieldFeature.properties.organisation.toLowerCase() === feature.properties.organisation.organisation.toLowerCase()) {
          return true
        }
        return false
      })

      var brownfieldMarkers = L.markerClusterGroup({
        showCoverageOnHover: false,
        zoomToBoundsOnClick: false,
        spiderfyOnMaxZoom: false,
        removeOutsideVisibleBounds: true,
        animate: false,
        disableClusteringAtZoom: 11,
        maxClusterRadius: 600,
        singleMarkerMode: false
      })
      var brownfieldOnMap = L.geoJSON({
        type: 'FeatureCollection',
        features: thisOrganisationsFeatures
      }, {
        pointToLayer: function (feature, latlng) {
          var size = isNaN(feature.properties.hectares) ? 100 : (Math.sqrt((feature.properties.hectares * 10000) / Math.PI))
          return L.circle(latlng, { color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: size.toFixed(2) })
        },
        onEachFeature: function (feature, layer) {
          layer.on({
            click: function () {
              sidebar.setContent('<h2>Loading...</h2>')
              sidebar.show()

              return Papa.parse('https://raw.githubusercontent.com/digital-land/map/master/docs/data/brownfield/' + feature.properties.organisation.toLowerCase().replace(':', '-') + '.csv', {
                download: true,
                header: true,
                complete: function (results) {
                  var point = results.data.find(function (row) {
                    return (row.latitude === feature.properties.latitude.toString()) && (row.longitude === feature.properties.longitude.toString())
                  })

                  if (point) {
                    content = ''

                    Object.keys(point).forEach(function (key) {
                      content = content + key + ': ' + point[key] + '<br>'
                    })
                  } else {
                    content = '<h2>Point not found - debug info:</h2><pre>' + JSON.stringify(results.data) + '</pre><h3>Looking for a row with latitude, longitude:</h3>' + feature.properties.latitude.toString() + ',' + feature.properties.longitude.toString()
                  }

                  sidebar.setContent(content)
                }
              })
            }
          })
        }
      })

      brownfieldMarkers.addLayer(brownfieldOnMap)
      map.addLayer(brownfieldMarkers)
    }

    layer.on({
      mouseover: function () {
        this.setStyle({
          fillColor: 'black',
          fillOpacity: 0.25
        })
      },
      mouseout: function () {
        this.setStyle({
          fillColor: 'white',
          fillOpacity: 0
        })
      },
      click: function () {
        return map.fitBounds(layer.getBounds())
      }
    })
  }
}).addTo(map)
</script>

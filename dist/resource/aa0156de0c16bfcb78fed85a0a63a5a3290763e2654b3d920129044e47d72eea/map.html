<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar@0.2.2/src/L.Control.Sidebar.css" crossorigin="" />

<style>
  body {
    margin: 0;
  }

  #map {
    width: 960px;
    height: 640px;
    transform: translate(-50%,-50%);
    position: absolute;
    top: 50%;
    left: 50%;
  }

  .leaflet-sidebar {
    display: none;
    width: 200px;
  }

  .leaflet-sidebar.visible {
    display: block;
  }

  .leaflet-sidebar .close {
    z-index: 10000;
  }

  .leaflet-marker-icon.marker-cluster {
    line-height: 18px;
    text-align: center;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    background: #fff;
    border: 2px solid #222;
  }
</style>

<div id="map"></div>
<div id="sidebar"></div>

<script>
  var geoJson = []
  var organisations = [{"organisation":"national-park-authority:Q4972284","wikidata":"Q4972284","name":"Broads Authority","website":"https://www.gov.uk/government/organisations/broads-authority","twitter":"","statistical-geography":"E26000007","toid":"","opendatacommunities":"http://opendatacommunities.org/id/national-park-authority/the-broads","opendatacommunities-area":"http://opendatacommunities.org/id/geography/administration/npark/E26000007","billing-authority":"E6408","census-area":"","local-authority-type":"","esd-inventories":"","start-date":"1978-01-01","end-date":""}]
  var brownfield = [{"entry-date":"2017-11-23","organisation":"national-park-authority:Q4972284","site":"BF000008","site-address":"Former Pegasus/Hamptons Site, Coldecott Road, Oulton Broad, Suffolk","site-plan-url":"http://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=M96Z8STBT0000","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"yes","latitude":"52.477034","longitude":"1.708607","hectares":"1.69","minimum-net-dwellings":"76","maximum-net-dwellings":"76","start-date":"2017-11-23","end-date":"","notes":"Was allocated in 2014 Site Specific Local Plan and allocated in emerging Local Plan policy OUL2. Details of the application (BA/2012/0271/FUL). Re-development of former Pegasus Boatyard to provide 76 dwellings, new boatyard buildings, office, moorings and new access road. Policy Number OUL2 and Planning Application Number BA/2012/0271/FUL.","resource":"aa0156de0c16bfcb78fed85a0a63a5a3290763e2654b3d920129044e47d72eea"},{"entry-date":"2017-11-23","organisation":"national-park-authority:Q4972284","site":"BF000001","site-address":"Derbys Quay Bridge Wharf Gillingham Dam Gillingham Beccles Norfolk NR34 0PA","site-plan-url":"http://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=MOJ2UJTB00200","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.464464","longitude":"1.560871","hectares":"0.03","minimum-net-dwellings":"2","maximum-net-dwellings":"2","start-date":"2017-11-23","end-date":"","notes":"Planning application number: BA/2013/0171/EXT8W extends time limit for BA/2010/0124/FUL.. Application to extend time limit of previous PP - BA/2010/0124/FUL for the conversion of offices and stores into two first floor holiday studio flats","resource":"aa0156de0c16bfcb78fed85a0a63a5a3290763e2654b3d920129044e47d72eea"},{"entry-date":"2017-11-23","organisation":"national-park-authority:Q4972284","site":"BF000010","site-address":"Hedera House, The Street, Thurne, Norfolk","site-plan-url":"http://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=ON9TEYTB01W00","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"outline planning permission","hazardous-substances":"","latitude":"52.686439","longitude":"1.554869","hectares":"0.77","minimum-net-dwellings":"16","maximum-net-dwellings":"16","start-date":"2017-11-23","end-date":"","notes":"Allocated in Sites Specifics Local Plan 2014 and draft allocated in emerging new Local Plan Policy THU1. Details of the planning application: BA/2017/0103/OUT. Outline application to redevelop Hedera House to form 6 residential dwellings and 10 new holiday cottages. Policy number THU1. Planning Application number: BA/2017/0103/OUT","resource":"aa0156de0c16bfcb78fed85a0a63a5a3290763e2654b3d920129044e47d72eea"},{"entry-date":"2017-11-23","organisation":"national-park-authority:Q4972284","site":"BF000007","site-address":"Building next to Kings Head Hotel, Station Road, Hoveton.","site-plan-url":"http://www.broads-authority.gov.uk/__data/assets/pdf_file/0007/995569/11_HOVETON-and-WROXHAM-new.pdf","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.712724","longitude":"1.409031","hectares":"0.03","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-11-23","end-date":"","notes":"Allocated in emerging Local Plan - Policy HOV3.. Allocated in emerging Local Plan for holiday accommodation. Policy HOV3.","resource":"aa0156de0c16bfcb78fed85a0a63a5a3290763e2654b3d920129044e47d72eea"},{"entry-date":"2017-11-23","organisation":"national-park-authority:Q4972284","site":"BF000009","site-address":"Spinnakers, near A143, St Olaves, Norfolk.","site-plan-url":"http://www.broads-authority.gov.uk/__data/assets/pdf_file/0012/995574/16_ST_OLAVES-new.pdf","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.534793","longitude":"1.617158","hectares":"0.12","minimum-net-dwellings":"1","maximum-net-dwellings":"1","start-date":"2017-11-23","end-date":"","notes":"Allocated in Sites Specifics Local Plan 2014. Allocated in emerging Local Plan Policy SOL2.. Allocated in emerging Local Plan for holiday accommodation amongst other uses to complement the flood risk in the area. Policy SOL2.","resource":"aa0156de0c16bfcb78fed85a0a63a5a3290763e2654b3d920129044e47d72eea"},{"entry-date":"2017-11-23","organisation":"national-park-authority:Q4972284","site":"BF000004","site-address":"Riverside House Woods End Kirby Bedon NR14 7ED","site-plan-url":"http://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=OF0SJATBG8V00","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"other","hazardous-substances":"","latitude":"52.605294","longitude":"1.380951","hectares":"0.21","minimum-net-dwellings":"1","maximum-net-dwellings":"1","start-date":"2017-11-23","end-date":"","notes":"Planning application number: BA/2016/0379/CU.. Extension to existing residential dwelling and conversion of outbuilding to holiday accommodation","resource":"aa0156de0c16bfcb78fed85a0a63a5a3290763e2654b3d920129044e47d72eea"},{"entry-date":"2017-11-23","organisation":"national-park-authority:Q4972284","site":"BF000003","site-address":"The Valley House Low Road Mettingham Suffolk NR35 1TS","site-plan-url":"http://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=NZUKQATBFTZ00","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.465423","longitude":"1.472336","hectares":"2.56","minimum-net-dwellings":"4","maximum-net-dwellings":"4","start-date":"2017-11-23","end-date":"","notes":"BA/2014/0239/FUL withdrawn. BA/2003/6138/HISTAP  Approved subject to conditions.. Conversion of existing barns and outbuildings to form new residential units and erection of a new stable block.","resource":"aa0156de0c16bfcb78fed85a0a63a5a3290763e2654b3d920129044e47d72eea"},{"entry-date":"2017-11-23","organisation":"national-park-authority:Q4972284","site":"BF000002","site-address":"Barnes Brinkcraft (Formerly Moore & Co), Staitheway Road, Wroxham, Norwich, NR12 8TH","site-plan-url":"http://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=NXYOW9TB01W00","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.709253","longitude":"1.406998","hectares":"0.06","minimum-net-dwellings":"3","maximum-net-dwellings":"3","start-date":"2017-11-23","end-date":"","notes":"Planning application number: BA/2015/0381/FUL .. BA/2015/0381/FUL Part demolition of boatshed and erection of 3 no. holiday dwellings. Application for re-approval of extant permission BA/2013/0019/FUL.","resource":"aa0156de0c16bfcb78fed85a0a63a5a3290763e2654b3d920129044e47d72eea"},{"entry-date":"2017-11-23","organisation":"national-park-authority:Q4972284","site":"BF000006","site-address":"Former Waterside Rooms, Station Road, Hoveton.","site-plan-url":"http://www.broads-authority.gov.uk/__data/assets/pdf_file/0007/995569/11_HOVETON-and-WROXHAM-new.pdf","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.712854","longitude":"1.40878","hectares":"0.1","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-11-23","end-date":"","notes":"Allocated in emerging Local Plan - Policy HOV3.. Allocated in emerging Local Plan for A3 and A4 uses and an element of residential may be acceptable. Policy HOV3.","resource":"aa0156de0c16bfcb78fed85a0a63a5a3290763e2654b3d920129044e47d72eea"},{"entry-date":"2017-11-23","organisation":"national-park-authority:Q4972284","site":"BF000005","site-address":"Old Broads Hotel Site, Station Road, Hoveton","site-plan-url":"http://www.broads-authority.gov.uk/__data/assets/pdf_file/0007/995569/11_HOVETON-and-WROXHAM-new.pdf","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.713662","longitude":"1.408405","hectares":"0.11","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-11-23","end-date":"","notes":"Allocated in emerging Local Plan - Policy HOV3.. Allocated in emerging Local Plan for A3 and A4 land uses and an element of residential may be acceptable. Policy HOV3.","resource":"aa0156de0c16bfcb78fed85a0a63a5a3290763e2654b3d920129044e47d72eea"},{"entry-date":"2017-11-23","organisation":"national-park-authority:Q4972284","site":"BF000011","site-address":"Utilities Site","site-plan-url":"http://www.broads-authority.gov.uk/__data/assets/pdf_file/0008/995570/12_NORWICH-new.pdf","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"yes","latitude":"52.622972","longitude":"1.323572","hectares":"4.49","minimum-net-dwellings":"120","maximum-net-dwellings":"120","start-date":"2017-11-23","end-date":"","notes":"Allocated in Sites Specific Local Plan 2014 and emerging Local Plan Policy Number NOR1. Previous application withdrawn (BA/2015/0225/FUL). Potential for hazardarous substances to be present on the site.. Withdrawn application was described as: Full planning permission for demolition works and the development, on the Utilities site, of a biomass fuelled energy centre (49.9 MWe installed capacity), associated fuel storage, offloading facilities and railway works, district heating network centre and associated utilities linkages to the Carrow Works; 435 units of student accommodation; commercial units; boat moorings, landscaping and public realm provision; controlled access to Hardy Road and new vehicular access via the Deal Ground with new vehicular bridges over the River Wensum and River Yare; together with associated infrastructure works and all enabling and preparatory works. Outline planning permission (with all matters reserved) for demolition works and provision of 120 residential dwellings; 282 units of student accommodation; research centre; data centre; education centre; offices and training buildings; a new pedestrian and cycle access to Cremorne Lane; boat moorings, landscaping and public realm provision; together with associated infrastructure works and all enabling and preparatory works.","resource":"aa0156de0c16bfcb78fed85a0a63a5a3290763e2654b3d920129044e47d72eea"}]
</script>

<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-sidebar@0.2.2/src/L.Control.Sidebar.js" crossorigin=""></script>
<script src="https://unpkg.com/papaparse@5.1.1/papaparse.min.js" crossorigin=""></script>

<script>
var map = L.map('map', {
  preferCanvas: true,
  fullscreenControl: true
}).setView([52.561928, -1.464854], 7)

// Tile layers
L.tileLayer('https://tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
  id: 'base',
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map)

// Sidebar
var sidebar = L.control.sidebar('sidebar', {
  position: 'right'
})

map.addControl(sidebar)

// Brownfield Features
var brownfieldFeatures = brownfield.map(function (point) {
  return {
    type: 'Feature',
    geometry: {
      type: 'Point',
      coordinates: [point.longitude, point.latitude]
    },
    properties: point
  }
})

// Local authority boundaries (England only)
geoJson = geoJson.features.filter(function (item) {
  return item.properties.lad19cd.startsWith('E')
}).map(function (item) {
  var lad19cd = item.properties.lad19cd
  if (item.properties.lad19cd === 'E06000057') {
    // Northumberland
    lad19cd = 'E06000048'
  } else if (item.properties.lad19cd === 'E07000240') {
    // St Albans
    lad19cd = 'E07000100'
  } else if (item.properties.lad19cd === 'E07000241') {
    // Welwyn Hatfield
    lad19cd = 'E07000104'
  } else if (item.properties.lad19cd === 'E07000242') {
    // East Hertfordshire
    lad19cd = 'E07000097'
  } else if (item.properties.lad19cd === 'E07000243') {
    // Stevenage
    lad19cd = 'E07000101'
  } else if (item.properties.lad19cd === 'E08000037') {
    // Gateshead
    lad19cd = 'E08000020'
  }

  item.properties.organisation = organisations.find(function (organisation) {
    if (organisation['statistical-geography'] && organisation['statistical-geography'].length) {
      return organisation['statistical-geography'].toString().toLowerCase() === lad19cd.toString().toLowerCase()
    }
  })

  return item
})

L.geoJSON(geoJson, {
  style: {
    fillOpacity: 0,
    weight: 2,
    color: 'gray'
  },
  onEachFeature: function (feature, layer) {
    if(organisations.length === 1) {
      map.fitBounds(layer.getBounds())
    }

    if (!feature.properties.organisation) {
      layer.setStyle({
        fillColor: 'red',
        fillOpacity: 0.25
      })
    } else {
      var thisOrganisationsFeatures = brownfieldFeatures.filter(function (brownfieldFeature) {
        if (brownfieldFeature.properties.organisation.toLowerCase() === feature.properties.organisation.organisation.toLowerCase()) {
          return true
        }
        return false
      })

      var brownfieldMarkers = L.markerClusterGroup({
        showCoverageOnHover: false,
        zoomToBoundsOnClick: false,
        spiderfyOnMaxZoom: false,
        removeOutsideVisibleBounds: true,
        animate: false,
        disableClusteringAtZoom: 11,
        maxClusterRadius: 600,
        singleMarkerMode: false
      })
      var brownfieldOnMap = L.geoJSON({
        type: 'FeatureCollection',
        features: thisOrganisationsFeatures
      }, {
        pointToLayer: function (feature, latlng) {
          var size = isNaN(feature.properties.hectares) ? 100 : (Math.sqrt((feature.properties.hectares * 10000) / Math.PI))
          return L.circle(latlng, { color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: size.toFixed(2) })
        },
        onEachFeature: function (feature, layer) {
          layer.on({
            click: function () {
              sidebar.setContent('<h2>Loading...</h2>')
              sidebar.show()

              return Papa.parse('https://raw.githubusercontent.com/digital-land/map/master/docs/data/brownfield/' + feature.properties.organisation.toLowerCase().replace(':', '-') + '.csv', {
                download: true,
                header: true,
                complete: function (results) {
                  var point = results.data.find(function (row) {
                    return (row.latitude === feature.properties.latitude.toString()) && (row.longitude === feature.properties.longitude.toString())
                  })

                  if (point) {
                    content = ''

                    Object.keys(point).forEach(function (key) {
                      content = content + key + ': ' + point[key] + '<br>'
                    })
                  } else {
                    content = '<h2>Point not found - debug info:</h2><pre>' + JSON.stringify(results.data) + '</pre><h3>Looking for a row with latitude, longitude:</h3>' + feature.properties.latitude.toString() + ',' + feature.properties.longitude.toString()
                  }

                  sidebar.setContent(content)
                }
              })
            }
          })
        }
      })

      brownfieldMarkers.addLayer(brownfieldOnMap)
      map.addLayer(brownfieldMarkers)
    }

    layer.on({
      mouseover: function () {
        this.setStyle({
          fillColor: 'black',
          fillOpacity: 0.25
        })
      },
      mouseout: function () {
        this.setStyle({
          fillColor: 'white',
          fillOpacity: 0
        })
      },
      click: function () {
        return map.fitBounds(layer.getBounds())
      }
    })
  }
}).addTo(map)
</script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar@0.2.2/src/L.Control.Sidebar.css" crossorigin="" />

<style>
  body {
    margin: 0;
  }

  #map {
    width: 960px;
    height: 640px;
    transform: translate(-50%,-50%);
    position: absolute;
    top: 50%;
    left: 50%;
  }

  .leaflet-sidebar {
    display: none;
    width: 200px;
  }

  .leaflet-sidebar.visible {
    display: block;
  }

  .leaflet-sidebar .close {
    z-index: 10000;
  }

  .leaflet-marker-icon.marker-cluster {
    line-height: 18px;
    text-align: center;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    background: #fff;
    border: 2px solid #222;
  }
</style>

<div id="map"></div>
<div id="sidebar"></div>

<script>
  var geoJson = []
  var organisations = [{"organisation":"development-corporation:Q20648596","wikidata":"Q20648596","name":"Old Oak and Park Royal Development Corporation","website":"https://www.london.gov.uk/about-us/organisations-we-work/old-oak-and-park-royal-development-corporation-opdc","twitter":"","statistical-geography":"E51000002","toid":"","opendatacommunities":"http://opendatacommunities.org/id/dev-corp/old-oak-and-park-royal","opendatacommunities-area":"","billing-authority":"","census-area":"","local-authority-type":"","esd-inventories":"","start-date":"2015-04-01","end-date":""}]
  var brownfield = [{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS1","site-address":"Land east of Willesden Junction Station","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.53246","longitude":"-0.240301","hectares":"1.6","minimum-net-dwellings":"700","maximum-net-dwellings":"700","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS2","site-address":"2 Scrubs Lane","site-plan-url":"https://data.london.gov.uk/","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"pending decision","planning-permission-type":"","hazardous-substances":"","latitude":"51.531963","longitude":"-0.237725","hectares":"0.1","minimum-net-dwellings":"85","maximum-net-dwellings":"85","start-date":"2027-12-15","end-date":"","notes":"Permission is subject to S106 being agreed. \"20-storey building, 85 C3 homes  of which 28 affordable\"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS5","site-address":"Car Giant","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.527272","longitude":"-0.239694","hectares":"9.7","minimum-net-dwellings":"5600","maximum-net-dwellings":"5600","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS6","site-address":"EMR","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.529977","longitude":"-0.241983","hectares":"1.8","minimum-net-dwellings":"1200","maximum-net-dwellings":"1200","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS7","site-address":"Cumberland Business Park","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.529215","longitude":"-0.23737","hectares":"1.1","minimum-net-dwellings":"250","maximum-net-dwellings":"250","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS8","site-address":"North Kensington Gate North","site-plan-url":"https://data.london.gov.uk/","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"pending decision","planning-permission-type":"","hazardous-substances":"","latitude":"51.527993","longitude":"-0.235402","hectares":"0.2","minimum-net-dwellings":"47","maximum-net-dwellings":"47","start-date":"2027-12-15","end-date":"","notes":"Permission is subject to S106 being agreed. \"4-storey and 11-storey buildings, 47 C3 homes of which 15 affordable\"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS9","site-address":"Mitre Yard","site-plan-url":"https://data.london.gov.uk/","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"pending decision","planning-permission-type":"","hazardous-substances":"","latitude":"51.527194","longitude":"-0.235433","hectares":"0.5","minimum-net-dwellings":"200","maximum-net-dwellings":"200","start-date":"2027-12-15","end-date":"","notes":"Permission is subject to S106 being agreed. \"19-storey building, 200 C3 homes of which 67 affordable\"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS10","site-address":"North Kensington Gate South","site-plan-url":"https://data.london.gov.uk/","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"pending decision","planning-permission-type":"","hazardous-substances":"","latitude":"51.526645","longitude":"-0.234356","hectares":"0.1","minimum-net-dwellings":"164","maximum-net-dwellings":"164","start-date":"2027-12-15","end-date":"","notes":"Permission is subject to S106 being agreed. \"6 to 20-storey buildings, 164  C3 homes of which 44 affordable\"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS11","site-address":"Mitre Wharf","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.526241","longitude":"-0.234097","hectares":"0.1","minimum-net-dwellings":"80","maximum-net-dwellings":"80","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS12","site-address":"Willesden Junction Depot","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.531449","longitude":"-0.239968","hectares":"0.2","minimum-net-dwellings":"50","maximum-net-dwellings":"50","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS13","site-address":"2 Victoria Terrace","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.524965","longitude":"-0.256048","hectares":"","minimum-net-dwellings":"15","maximum-net-dwellings":"15","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS14","site-address":"Oaklands Triangle","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.528293","longitude":"-0.249123","hectares":"0.3","minimum-net-dwellings":"50","maximum-net-dwellings":"50","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS15","site-address":"Oaklands North","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.527815","longitude":"-0.248928","hectares":"0.7","minimum-net-dwellings":"250","maximum-net-dwellings":"250","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS16","site-address":"Oaklands, Old Oak Common Lane, London, NW10 6DU","site-plan-url":"https://data.london.gov.uk/","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"51.527171","longitude":"-0.249166","hectares":"1","minimum-net-dwellings":"605","maximum-net-dwellings":"605","start-date":"2027-12-15","end-date":"","notes":". \"6 to 26-storey buildings, 601 C3 homes of which 242 affordable\"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS17","site-address":"Old Oak South","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"mixed ownership","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.525819","longitude":"-0.246297","hectares":"14.1","minimum-net-dwellings":"3000","maximum-net-dwellings":"3000","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS19","site-address":"Big Yellow Storage","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.5249","longitude":"-0.233539","hectares":"0.2","minimum-net-dwellings":"100","maximum-net-dwellings":"100","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS21","site-address":"Mitre Industrial Estate","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.5245","longitude":"-0.230991","hectares":"0.9","minimum-net-dwellings":"300","maximum-net-dwellings":"300","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS22","site-address":"Tea Crate","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.52371","longitude":"-0.231601","hectares":"0.4","minimum-net-dwellings":"100","maximum-net-dwellings":"100","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS23","site-address":"Acton Wells","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.52456","longitude":"-0.255338","hectares":"3.5","minimum-net-dwellings":"1300","maximum-net-dwellings":"1300","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS24","site-address":"Boden House","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.52378","longitude":"-0.25665","hectares":"0.7","minimum-net-dwellings":"300","maximum-net-dwellings":"300","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS25","site-address":"Midland Gate","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.525368","longitude":"-0.253385","hectares":"0.2","minimum-net-dwellings":"50","maximum-net-dwellings":"50","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS26","site-address":"Holbrook House, Victoria Road Acton W3 6UW","site-plan-url":"https://data.london.gov.uk/","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"51.522915","longitude":"-0.258666","hectares":"0.1","minimum-net-dwellings":"424","maximum-net-dwellings":"424","start-date":"2027-12-15","end-date":"","notes":". \"16 to 24-storey buildings comprising 424 student bed spaces\"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS27","site-address":"Perfume Factory North, 140 Wales Farm Road, Acton W3 6UG","site-plan-url":"https://data.london.gov.uk/","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"pending decision","planning-permission-type":"","hazardous-substances":"","latitude":"51.52227","longitude":"-0.257501","hectares":"0.5","minimum-net-dwellings":"250","maximum-net-dwellings":"250","start-date":"2027-12-15","end-date":"","notes":"Application pending consideration. \"3  buildings between 12 and 25 storeys in height to provide 390 residential units of which 105 affordable\"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS29","site-address":"Victoria Estate","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.520648","longitude":"-0.257258","hectares":"1.7","minimum-net-dwellings":"1100","maximum-net-dwellings":"1100","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS30","site-address":"6 Portal West, North Acton W3 6RU","site-plan-url":"https://data.london.gov.uk/","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"51.522109","longitude":"-0.262053","hectares":"0.6","minimum-net-dwellings":"580","maximum-net-dwellings":"580","start-date":"2027-12-15","end-date":"","notes":". \"Four buildings of 2, 9, 11, 32 and 42 storeys comprising 578 residential flats, 164 affordable\"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS31","site-address":"Carphone Warehouse 1 Portal Way Acton W3 6RT","site-plan-url":"https://data.london.gov.uk/","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"outline planning permission","hazardous-substances":"","latitude":"51.521577","longitude":"-0.260823","hectares":"1.1","minimum-net-dwellings":"760","maximum-net-dwellings":"760","start-date":"2027-12-15","end-date":"","notes":". \" 8 blocks ranging in height from 6 to 32 storeys to incorporate up to 764 residential flats\"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS32","site-address":"The Portal, The Portal Land At Wales Farm Road & Portal Way. Acton W3 6EJ","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"mixed ownership","planning-permission-status":"pending decision","planning-permission-type":"","hazardous-substances":"","latitude":"51.522012","longitude":"-0.259372","hectares":"0.1","minimum-net-dwellings":"350","maximum-net-dwellings":"350","start-date":"2027-12-15","end-date":"","notes":"Permission is subject to S106 being agreed. \"Part 10, part 36 storey building comprising 355 residential units, 30% affordable\"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS33","site-address":"Perfume Factory South, 140 Wales Farm Road, Acton W3 6UG","site-plan-url":"https://data.london.gov.uk/","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"51.521764","longitude":"-0.258008","hectares":"0.5","minimum-net-dwellings":"250","maximum-net-dwellings":"250","start-date":"2027-12-15","end-date":"","notes":". \"Five buildings of 5, 7, 10, 11 and 31 storeys comprising 736 student bed spaces, 85 residential flats\"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS34","site-address":"Algerian Embassy","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.52168","longitude":"-0.262619","hectares":"0.4","minimum-net-dwellings":"200","maximum-net-dwellings":"200","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS35","site-address":"2 Portal Way, Acton W3 6RT","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"pending decision","planning-permission-type":"","hazardous-substances":"","latitude":"51.52073","longitude":"-0.261495","hectares":"0.2","minimum-net-dwellings":"300","maximum-net-dwellings":"300","start-date":"2027-12-15","end-date":"","notes":"Application pending consideration. \"Two buildings of 25 and 35 storeys comprising 380 residential flats\"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS36","site-address":"Shurguard","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.520037","longitude":"-0.262254","hectares":"0.2","minimum-net-dwellings":"100","maximum-net-dwellings":"100","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS37","site-address":"Big Yellow Storage (Wales Farm Road)","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.51957","longitude":"-0.26154","hectares":"0.5","minimum-net-dwellings":"50","maximum-net-dwellings":"50","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS39","site-address":"Westway Estate","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.520129","longitude":"-0.253067","hectares":"3.7","minimum-net-dwellings":"1400","maximum-net-dwellings":"1400","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS40","site-address":"Old Oak Common Lane sites","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"mixed ownership","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.521258","longitude":"-0.251536","hectares":"0.6","minimum-net-dwellings":"200","maximum-net-dwellings":"200","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS41","site-address":"ASDA, Park Royal","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.52842","longitude":"-0.269333","hectares":"4","minimum-net-dwellings":"500","maximum-net-dwellings":"500","start-date":"2027-12-15","end-date":"","notes":"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS42","site-address":"247 Acton Lane","site-plan-url":"https://data.london.gov.uk/","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"pending decision","planning-permission-type":"","hazardous-substances":"","latitude":"51.534934","longitude":"-0.258556","hectares":"0.3","minimum-net-dwellings":"150","maximum-net-dwellings":"150","start-date":"2027-12-15","end-date":"","notes":"Permission is subject to S106 being agreed. \"Part 4, 5, 6 and 9 storey building comprising 141  extra care units (Use Class C2), 48 being affordable\"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS43","site-address":"First Central and surrounds","site-plan-url":"https://data.london.gov.uk/","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"51.530042","longitude":"-0.282546","hectares":"2.7","minimum-net-dwellings":"393","maximum-net-dwellings":"393","start-date":"2027-12-15","end-date":"","notes":"This site includes an extant pemission for a hotel to the south of Coronation Road which has not been built out","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"},{"entry-date":"2027-12-15","organisation":"development-corporation:Q20648596","site":"DCS43a","site-address":"First Central, Lakeside Drive","site-plan-url":"https://data.london.gov.uk/","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"51.530042","longitude":"-0.282546","hectares":"2.4","minimum-net-dwellings":"807","maximum-net-dwellings":"807","start-date":"2027-12-15","end-date":"","notes":". \"5 to 27-storey buildings, 807 C3 homes of which 263 affordable\"","resource":"cd5ea36ba52b11b51f6b9bab380710646daf8607bd210758168d8bdfbcf74504"}]
</script>

<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-sidebar@0.2.2/src/L.Control.Sidebar.js" crossorigin=""></script>
<script src="https://unpkg.com/papaparse@5.1.1/papaparse.min.js" crossorigin=""></script>

<script>
var map = L.map('map', {
  preferCanvas: true,
  fullscreenControl: true
}).setView([52.561928, -1.464854], 7)

// Tile layers
L.tileLayer('https://tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
  id: 'base',
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map)

// Sidebar
var sidebar = L.control.sidebar('sidebar', {
  position: 'right'
})

map.addControl(sidebar)

// Brownfield Features
var brownfieldFeatures = brownfield.map(function (point) {
  return {
    type: 'Feature',
    geometry: {
      type: 'Point',
      coordinates: [point.longitude, point.latitude]
    },
    properties: point
  }
})

// Local authority boundaries (England only)
geoJson = geoJson.features.filter(function (item) {
  return item.properties.lad19cd.startsWith('E')
}).map(function (item) {
  var lad19cd = item.properties.lad19cd
  if (item.properties.lad19cd === 'E06000057') {
    // Northumberland
    lad19cd = 'E06000048'
  } else if (item.properties.lad19cd === 'E07000240') {
    // St Albans
    lad19cd = 'E07000100'
  } else if (item.properties.lad19cd === 'E07000241') {
    // Welwyn Hatfield
    lad19cd = 'E07000104'
  } else if (item.properties.lad19cd === 'E07000242') {
    // East Hertfordshire
    lad19cd = 'E07000097'
  } else if (item.properties.lad19cd === 'E07000243') {
    // Stevenage
    lad19cd = 'E07000101'
  } else if (item.properties.lad19cd === 'E08000037') {
    // Gateshead
    lad19cd = 'E08000020'
  }

  item.properties.organisation = organisations.find(function (organisation) {
    if (organisation['statistical-geography'] && organisation['statistical-geography'].length) {
      return organisation['statistical-geography'].toString().toLowerCase() === lad19cd.toString().toLowerCase()
    }
  })

  return item
})

L.geoJSON(geoJson, {
  style: {
    fillOpacity: 0,
    weight: 2,
    color: 'gray'
  },
  onEachFeature: function (feature, layer) {
    if(organisations.length === 1) {
      map.fitBounds(layer.getBounds())
    }

    if (!feature.properties.organisation) {
      layer.setStyle({
        fillColor: 'red',
        fillOpacity: 0.25
      })
    } else {
      var thisOrganisationsFeatures = brownfieldFeatures.filter(function (brownfieldFeature) {
        if (brownfieldFeature.properties.organisation.toLowerCase() === feature.properties.organisation.organisation.toLowerCase()) {
          return true
        }
        return false
      })

      var brownfieldMarkers = L.markerClusterGroup({
        showCoverageOnHover: false,
        zoomToBoundsOnClick: false,
        spiderfyOnMaxZoom: false,
        removeOutsideVisibleBounds: true,
        animate: false,
        disableClusteringAtZoom: 11,
        maxClusterRadius: 600,
        singleMarkerMode: false
      })
      var brownfieldOnMap = L.geoJSON({
        type: 'FeatureCollection',
        features: thisOrganisationsFeatures
      }, {
        pointToLayer: function (feature, latlng) {
          var size = isNaN(feature.properties.hectares) ? 100 : (Math.sqrt((feature.properties.hectares * 10000) / Math.PI))
          return L.circle(latlng, { color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: size.toFixed(2) })
        },
        onEachFeature: function (feature, layer) {
          layer.on({
            click: function () {
              sidebar.setContent('<h2>Loading...</h2>')
              sidebar.show()

              return Papa.parse('https://raw.githubusercontent.com/digital-land/map/master/docs/data/brownfield/' + feature.properties.organisation.toLowerCase().replace(':', '-') + '.csv', {
                download: true,
                header: true,
                complete: function (results) {
                  var point = results.data.find(function (row) {
                    return (row.latitude === feature.properties.latitude.toString()) && (row.longitude === feature.properties.longitude.toString())
                  })

                  if (point) {
                    content = ''

                    Object.keys(point).forEach(function (key) {
                      content = content + key + ': ' + point[key] + '<br>'
                    })
                  } else {
                    content = '<h2>Point not found - debug info:</h2><pre>' + JSON.stringify(results.data) + '</pre><h3>Looking for a row with latitude, longitude:</h3>' + feature.properties.latitude.toString() + ',' + feature.properties.longitude.toString()
                  }

                  sidebar.setContent(content)
                }
              })
            }
          })
        }
      })

      brownfieldMarkers.addLayer(brownfieldOnMap)
      map.addLayer(brownfieldMarkers)
    }

    layer.on({
      mouseover: function () {
        this.setStyle({
          fillColor: 'black',
          fillOpacity: 0.25
        })
      },
      mouseout: function () {
        this.setStyle({
          fillColor: 'white',
          fillOpacity: 0
        })
      },
      click: function () {
        return map.fitBounds(layer.getBounds())
      }
    })
  }
}).addTo(map)
</script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar@0.2.2/src/L.Control.Sidebar.css" crossorigin="" />

<style>
  body {
    margin: 0;
  }

  #map {
    width: 960px;
    height: 640px;
    transform: translate(-50%,-50%);
    position: absolute;
    top: 50%;
    left: 50%;
  }

  .leaflet-sidebar {
    display: none;
    width: 200px;
  }

  .leaflet-sidebar.visible {
    display: block;
  }

  .leaflet-sidebar .close {
    z-index: 10000;
  }

  .leaflet-marker-icon.marker-cluster {
    line-height: 18px;
    text-align: center;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    background: #fff;
    border: 2px solid #222;
  }
</style>

<div id="map"></div>
<div id="sidebar"></div>

<script>
  var geoJson = []
  var organisations = [{"organisation":"national-park-authority:Q4972284","wikidata":"Q4972284","name":"Broads Authority","website":"https://www.gov.uk/government/organisations/broads-authority","twitter":"","statistical-geography":"E26000007","toid":"","opendatacommunities":"http://opendatacommunities.org/id/national-park-authority/the-broads","opendatacommunities-area":"http://opendatacommunities.org/id/geography/administration/npark/E26000007","billing-authority":"E6408","census-area":"","local-authority-type":"","esd-inventories":"","start-date":"1978-01-01","end-date":""}]
  var brownfield = [{"entry-date":"2019-12-04","organisation":"national-park-authority:Q4972284","site":"BF000025","site-address":"Broadlands Park Marsh Road Lowestoft NR33 9JY","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=PRJ372TBHJ300","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.469612","longitude":"1.70622","hectares":"0.238","minimum-net-dwellings":"1","maximum-net-dwellings":"1","start-date":"2019-12-04","end-date":"","notes":"Planning application number BA/2019/0168/FUL","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2018-12-20","organisation":"national-park-authority:Q4972284","site":"BF000013","site-address":"The Old Stables Hall Farm Hall Lane Postwick NR13 5HQ","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=OR7OJATBGJA00","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.614791","longitude":"1.388568","hectares":"1.324","minimum-net-dwellings":"1","maximum-net-dwellings":"1","start-date":"2018-12-20","end-date":"","notes":"Planning application number: BA/2017/0191/FUL","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2018-12-20","organisation":"national-park-authority:Q4972284","site":"BF000006","site-address":"Former Waterside Rooms, Station Road, Hoveton.","site-plan-url":"https://www.broads-authority.gov.uk/__data/assets/pdf_file/0007/995569/11_HOVETON-and-WROXHAM-new.pdf","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.712854","longitude":"1.40878","hectares":"0.101","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-11-23","end-date":"","notes":"Allocated in emerging Local Plan - Policy HOV3.","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2019-12-04","organisation":"national-park-authority:Q4972284","site":"BF000028","site-address":"The Rhond Hoveton Norfolk NR12 8UE","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=PF8T1BTB01U00","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.710224","longitude":"1.410638","hectares":"0.02","minimum-net-dwellings":"1","maximum-net-dwellings":"1","start-date":"2019-12-04","end-date":"","notes":"Planning application number BA/2018/0374/FUL","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2018-12-20","organisation":"national-park-authority:Q4972284","site":"BF000014","site-address":"The Pyghtle Broad Road Ranworth Norwich Norfolk NR13 6HS","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=OQCGB0TB01W00","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.679079","longitude":"1.486935","hectares":"0.118","minimum-net-dwellings":"1","maximum-net-dwellings":"1","start-date":"2018-12-20","end-date":"","notes":"Planning application number BA/2017/0170/HOUSEH","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2018-12-20","organisation":"national-park-authority:Q4972284","site":"BF000019","site-address":"Land At The Manor Staithe Road Ludham Norfolk NR29 5AB","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=NNWV80TBFJN00","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.709423","longitude":"1.536554","hectares":"0.179","minimum-net-dwellings":"1","maximum-net-dwellings":"1","start-date":"2018-12-20","end-date":"","notes":"Planning application number BA/2015/0148/FUL","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2018-12-20","organisation":"national-park-authority:Q4972284","site":"BF000018","site-address":"Claxton Manor Barn Complex The Street Claxton Norfolk NR14 7AS","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=NRM7AOTBFML00","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.581123","longitude":"1.446291","hectares":"0.49","minimum-net-dwellings":"2","maximum-net-dwellings":"2","start-date":"2018-12-20","end-date":"","notes":"Planning application number BA/2015/0246/FUL","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2018-12-20","organisation":"national-park-authority:Q4972284","site":"BF000015","site-address":"Erequay The Rhond Hoveton Norfolk NR12 8UE","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=OGFOMLTB01U00","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.710436","longitude":"1.410615","hectares":"0.079","minimum-net-dwellings":"2","maximum-net-dwellings":"2","start-date":"2018-12-20","end-date":"","notes":"Planning application number BA/2016/0408/FUL","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2018-12-20","organisation":"national-park-authority:Q4972284","site":"BF000008","site-address":"Former Pegasus/Hamptons Site, Coldecott Road, Oulton Broad, Suffolk","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=M96Z8STBT0000","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"yes","latitude":"52.477034","longitude":"1.708607","hectares":"1.7","minimum-net-dwellings":"76","maximum-net-dwellings":"76","start-date":"2017-11-23","end-date":"","notes":"Was allocated in 2014 Site Specific Local Plan and allocated in emerging Local Plan policy OUL2. Details of the application (BA/2012/0271/FUL)","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2018-12-20","organisation":"national-park-authority:Q4972284","site":"BF000005","site-address":"Old Broads Hotel Site, Station Road, Hoveton","site-plan-url":"https://www.broads-authority.gov.uk/__data/assets/pdf_file/0007/995569/11_HOVETON-and-WROXHAM-new.pdf","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.713662","longitude":"1.408405","hectares":"0.114","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-11-23","end-date":"","notes":"Allocated in emerging Local Plan - Policy HOV3.","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2019-12-04","organisation":"national-park-authority:Q4972284","site":"BF000026","site-address":"73 Northgate Beccles NR34 9AY","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=PLESMXTBHCT00","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.463278","longitude":"1.563454","hectares":"0.004","minimum-net-dwellings":"1","maximum-net-dwellings":"1","start-date":"2019-12-04","end-date":"","notes":"Planning application number BA/2019/0018/FUL","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2018-12-20","organisation":"national-park-authority:Q4972284","site":"BF000001","site-address":"Derbys Quay Bridge Wharf Gillingham Dam Gillingham Beccles Norfolk NR34 0PA","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=MOJ2UJTB00200","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.464464","longitude":"1.560871","hectares":"0.03","minimum-net-dwellings":"2","maximum-net-dwellings":"2","start-date":"2017-11-23","end-date":"","notes":"Planning application number: BA/2013/0171/EXT8W extends time limit for BA/2010/0124/FUL.","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2019-12-04","organisation":"national-park-authority:Q4972284","site":"BF000022","site-address":"Land Adjacent To Cordova Cottages The Staithe Stalham NR12 9BZ","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=POZCTZTB02300","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.767308","longitude":"1.517847","hectares":"0.063","minimum-net-dwellings":"3","maximum-net-dwellings":"3","start-date":"2019-12-04","end-date":"","notes":"Planning application number BA/2019/0112/FUL","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2018-12-20","organisation":"national-park-authority:Q4972284","site":"BF000010","site-address":"Hedera House, The Street, Thurne, Norfolk","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=ON9TEYTB01W00","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"outline planning permission","hazardous-substances":"","latitude":"52.686439","longitude":"1.554869","hectares":"0.777","minimum-net-dwellings":"16","maximum-net-dwellings":"16","start-date":"2017-11-23","end-date":"","notes":"Allocated in Sites Specifics Local Plan 2014 and draft allocated in emerging new Local Plan Policy THU1. Details of the planning application: BA/2017/0103/OUT","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2019-12-04","organisation":"national-park-authority:Q4972284","site":"BF000024","site-address":"Lawn Bungalow Tunstall Road Halvergate Great Yarmouth NR13 3FD","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=PMC4MTTBHE800","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.613552","longitude":"1.569016","hectares":"0.112","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2019-12-04","end-date":"","notes":"Planning application number BA/2019/0044/FUL","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2018-12-20","organisation":"national-park-authority:Q4972284","site":"BF000007","site-address":"Building next to Kings Head Hotel, Station Road, Hoveton.","site-plan-url":"https://www.broads-authority.gov.uk/__data/assets/pdf_file/0007/995569/11_HOVETON-and-WROXHAM-new.pdf","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.712724","longitude":"1.409031","hectares":"0.028","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-11-23","end-date":"","notes":"Allocated in emerging Local Plan - Policy HOV3.","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2018-12-20","organisation":"national-park-authority:Q4972284","site":"BF000012","site-address":"Old School House St Olaves Road Herringfleet NR32 5QT","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=P0VWNNTBGTD00","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.523774","longitude":"1.641309","hectares":"0.049","minimum-net-dwellings":"1","maximum-net-dwellings":"1","start-date":"2018-12-20","end-date":"","notes":"Planning application number: BA/2017/0484/FUL","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2018-12-20","organisation":"national-park-authority:Q4972284","site":"BF000011","site-address":"Utilities Site","site-plan-url":"http://www.broads-authority.gov.uk/__data/assets/pdf_file/0008/995570/12_NORWICH-new.pdf","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"yes","latitude":"52.622972","longitude":"1.323572","hectares":"4.512","minimum-net-dwellings":"120","maximum-net-dwellings":"120","start-date":"2017-11-23","end-date":"","notes":"Allocated in Sites Specific Local Plan 2014 and emerging Local Plan Policy Number NOR1. Previous application withdrawn (BA/2015/0225/FUL). Potential for hazardarous substances to be present on the site.","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2018-12-20","organisation":"national-park-authority:Q4972284","site":"BF000003","site-address":"The Valley House Low Road Mettingham Suffolk NR35 1TS","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=NZUKQATBFTZ00","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.465423","longitude":"1.472336","hectares":"2.577","minimum-net-dwellings":"4","maximum-net-dwellings":"4","start-date":"2017-11-23","end-date":"","notes":"BA/2014/0239/FUL withdrawn. BA/2003/6138/HISTAP  Approved subject to conditions.","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2019-12-04","organisation":"national-park-authority:Q4972284","site":"BF000027","site-address":"Formerly Windboats Marine Ltd Staitheway Road Wroxham Norwich Norfolk NR12 8TH","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=PIN7FQTB02300","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.709659","longitude":"1.406716","hectares":"0.016","minimum-net-dwellings":"1","maximum-net-dwellings":"1","start-date":"2019-12-04","end-date":"","notes":"Planning application number BA/2018/0477/PN","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2018-12-20","organisation":"national-park-authority:Q4972284","site":"BF000016","site-address":"Broadholme Caldecott Road Lowestoft Suffolk NR32 3PH","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=NT2RNQTB00500","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.476375","longitude":"1.707298","hectares":"0.163","minimum-net-dwellings":"3","maximum-net-dwellings":"3","start-date":"2018-12-20","end-date":"","notes":"Planning application number BA/2015/0277/FUL","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2019-12-04","organisation":"national-park-authority:Q4972284","site":"BF000023","site-address":"1 The Green Mill Road (track) Stokesby With Herringby Norfolk NR29 3EX","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=PN6JE9TB02300","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.638234","longitude":"1.59227","hectares":"0.01","minimum-net-dwellings":"1","maximum-net-dwellings":"1","start-date":"2019-12-04","end-date":"","notes":"Planning application number BA/2019/0063/CU","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2018-12-20","organisation":"national-park-authority:Q4972284","site":"BF000017","site-address":"Claxton Manor Barn Complex The Street Claxton Norfolk NR14 7AS","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=NRM7AOTBFML00","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.581123","longitude":"1.446291","hectares":"0.49","minimum-net-dwellings":"2","maximum-net-dwellings":"2","start-date":"2018-12-20","end-date":"","notes":"Planning application number BA/2015/0246/FUL","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2019-12-04","organisation":"national-park-authority:Q4972284","site":"BF000020","site-address":"28 Riverside Estate Brundall Norwich NR13 5PU","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=PJNTZPTBHBH00","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.615667","longitude":"1.436783","hectares":"0.033","minimum-net-dwellings":"1","maximum-net-dwellings":"1","start-date":"2019-12-04","end-date":"","notes":"Planning application number BA/2018/0504/FUL","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"},{"entry-date":"2019-12-04","organisation":"national-park-authority:Q4972284","site":"BF000021","site-address":"Port Of Yarmouth Marina Caister Road Great Yarmouth NR30 4DL","site-plan-url":"https://planning.broads-authority.gov.uk/online-applications/applicationDetails.do?activeTab=map&keyVal=PP5ZCSTBHH800","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.627706","longitude":"1.724869","hectares":"1.489","minimum-net-dwellings":"7","maximum-net-dwellings":"7","start-date":"2019-12-04","end-date":"","notes":"Planning application number BA/2019/0118/FUL","resource":"fe7279fffcd5e10a2c7919c869e19faf8e279deb706f97982eac0ef5a756bc75"}]
</script>

<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-sidebar@0.2.2/src/L.Control.Sidebar.js" crossorigin=""></script>
<script src="https://unpkg.com/papaparse@5.1.1/papaparse.min.js" crossorigin=""></script>

<script>
var map = L.map('map', {
  preferCanvas: true,
  fullscreenControl: true
}).setView([52.561928, -1.464854], 7)

// Tile layers
L.tileLayer('https://tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
  id: 'base',
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map)

// Sidebar
var sidebar = L.control.sidebar('sidebar', {
  position: 'right'
})

map.addControl(sidebar)

// Brownfield Features
var brownfieldFeatures = brownfield.map(function (point) {
  return {
    type: 'Feature',
    geometry: {
      type: 'Point',
      coordinates: [point.longitude, point.latitude]
    },
    properties: point
  }
})

// Local authority boundaries (England only)
geoJson = geoJson.features.filter(function (item) {
  return item.properties.lad19cd.startsWith('E')
}).map(function (item) {
  var lad19cd = item.properties.lad19cd
  if (item.properties.lad19cd === 'E06000057') {
    // Northumberland
    lad19cd = 'E06000048'
  } else if (item.properties.lad19cd === 'E07000240') {
    // St Albans
    lad19cd = 'E07000100'
  } else if (item.properties.lad19cd === 'E07000241') {
    // Welwyn Hatfield
    lad19cd = 'E07000104'
  } else if (item.properties.lad19cd === 'E07000242') {
    // East Hertfordshire
    lad19cd = 'E07000097'
  } else if (item.properties.lad19cd === 'E07000243') {
    // Stevenage
    lad19cd = 'E07000101'
  } else if (item.properties.lad19cd === 'E08000037') {
    // Gateshead
    lad19cd = 'E08000020'
  }

  item.properties.organisation = organisations.find(function (organisation) {
    if (organisation['statistical-geography'] && organisation['statistical-geography'].length) {
      return organisation['statistical-geography'].toString().toLowerCase() === lad19cd.toString().toLowerCase()
    }
  })

  return item
})

L.geoJSON(geoJson, {
  style: {
    fillOpacity: 0,
    weight: 2,
    color: 'gray'
  },
  onEachFeature: function (feature, layer) {
    if(organisations.length === 1) {
      map.fitBounds(layer.getBounds())
    }

    if (!feature.properties.organisation) {
      layer.setStyle({
        fillColor: 'red',
        fillOpacity: 0.25
      })
    } else {
      var thisOrganisationsFeatures = brownfieldFeatures.filter(function (brownfieldFeature) {
        if (brownfieldFeature.properties.organisation.toLowerCase() === feature.properties.organisation.organisation.toLowerCase()) {
          return true
        }
        return false
      })

      var brownfieldMarkers = L.markerClusterGroup({
        showCoverageOnHover: false,
        zoomToBoundsOnClick: false,
        spiderfyOnMaxZoom: false,
        removeOutsideVisibleBounds: true,
        animate: false,
        disableClusteringAtZoom: 11,
        maxClusterRadius: 600,
        singleMarkerMode: false
      })
      var brownfieldOnMap = L.geoJSON({
        type: 'FeatureCollection',
        features: thisOrganisationsFeatures
      }, {
        pointToLayer: function (feature, latlng) {
          var size = isNaN(feature.properties.hectares) ? 100 : (Math.sqrt((feature.properties.hectares * 10000) / Math.PI))
          return L.circle(latlng, { color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: size.toFixed(2) })
        },
        onEachFeature: function (feature, layer) {
          layer.on({
            click: function () {
              sidebar.setContent('<h2>Loading...</h2>')
              sidebar.show()

              return Papa.parse('https://raw.githubusercontent.com/digital-land/map/master/docs/data/brownfield/' + feature.properties.organisation.toLowerCase().replace(':', '-') + '.csv', {
                download: true,
                header: true,
                complete: function (results) {
                  var point = results.data.find(function (row) {
                    return (row.latitude === feature.properties.latitude.toString()) && (row.longitude === feature.properties.longitude.toString())
                  })

                  if (point) {
                    content = ''

                    Object.keys(point).forEach(function (key) {
                      content = content + key + ': ' + point[key] + '<br>'
                    })
                  } else {
                    content = '<h2>Point not found - debug info:</h2><pre>' + JSON.stringify(results.data) + '</pre><h3>Looking for a row with latitude, longitude:</h3>' + feature.properties.latitude.toString() + ',' + feature.properties.longitude.toString()
                  }

                  sidebar.setContent(content)
                }
              })
            }
          })
        }
      })

      brownfieldMarkers.addLayer(brownfieldOnMap)
      map.addLayer(brownfieldMarkers)
    }

    layer.on({
      mouseover: function () {
        this.setStyle({
          fillColor: 'black',
          fillOpacity: 0.25
        })
      },
      mouseout: function () {
        this.setStyle({
          fillColor: 'white',
          fillOpacity: 0
        })
      },
      click: function () {
        return map.fitBounds(layer.getBounds())
      }
    })
  }
}).addTo(map)
</script>

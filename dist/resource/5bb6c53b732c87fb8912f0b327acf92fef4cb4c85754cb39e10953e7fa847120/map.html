<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar@0.2.2/src/L.Control.Sidebar.css" crossorigin="" />

<style>
  body {
    margin: 0;
  }

  #map {
    width: 960px;
    height: 640px;
    transform: translate(-50%,-50%);
    position: absolute;
    top: 50%;
    left: 50%;
  }

  .leaflet-sidebar {
    display: none;
    width: 200px;
  }

  .leaflet-sidebar.visible {
    display: block;
  }

  .leaflet-sidebar .close {
    z-index: 10000;
  }

  .leaflet-marker-icon.marker-cluster {
    line-height: 18px;
    text-align: center;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    background: #fff;
    border: 2px solid #222;
  }
</style>

<div id="map"></div>
<div id="sidebar"></div>

<script>
  var geoJson = []
  var organisations = [{"organisation":"local-authority-eng:STV","wikidata":"Q7615422","name":"Stevenage Borough Council","website":"https://www.stevenage.gov.uk","twitter":"","statistical-geography":"E07000101","toid":"","opendatacommunities":"http://opendatacommunities.org/id/district-council/stevenage","opendatacommunities-area":"http://opendatacommunities.org/id/geography/administration/nmd/E07000243","billing-authority":"E1937","census-area":"26UH","local-authority-type":"NMD","esd-inventories":"","start-date":"","end-date":""}]
  var brownfield = [{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"714","site-address":"Archer Road NC","site-plan-url":"","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"51.909622","longitude":"-0.183968","hectares":"0.5","minimum-net-dwellings":"24","maximum-net-dwellings":"24","start-date":"2017-11-03","end-date":"","notes":". Demolition of community centre and existing mixed use shops and flats. Provision of 2 no. retail units, 8no. one bed and 9no. two bed flats and 9no. two bed and 4no. three bed houses with associated landscaping and car parking and construction of temporary car park.","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"721","site-address":"Bedwell Crescent Neighbourhood Centre","site-plan-url":"","deliverable":"","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.902226","longitude":"-0.188961","hectares":"1.62","minimum-net-dwellings":"45","maximum-net-dwellings":"45","start-date":"2017-11-03","end-date":"","notes":". Potentially contaminated","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"707","site-address":"Burwell Road Neighbourhood Centre","site-plan-url":"","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"pending decision","planning-permission-type":"","hazardous-substances":"","latitude":"51.897355","longitude":"-0.170509","hectares":"0.66","minimum-net-dwellings":"20","maximum-net-dwellings":"20","start-date":"2017-11-03","end-date":"","notes":". Erection of 6no two bedroom and 9no one bedroom flats with associated parking.","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"","site-address":"DuPont (UK) Ltd, Wedgwood Way, SG1 4QN","site-plan-url":"","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"outline planning permission","hazardous-substances":"","latitude":"51.922939","longitude":"-0.170618","hectares":"2.22","minimum-net-dwellings":"200","maximum-net-dwellings":"200","start-date":"2017-11-03","end-date":"","notes":". Outline planning application for the demolition of existing buildings and provision of up to 200 new homes, up to 900 sqm of Use classes A1/A2/A3/D1, provision of residential amenity space and associated access and car parking","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"BFR3","site-address":"Former Lonsdale School","site-plan-url":"","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"outline planning permission","hazardous-substances":"","latitude":"51.911615","longitude":"-0.187304","hectares":"3.8","minimum-net-dwellings":"67","maximum-net-dwellings":"67","start-date":"2017-11-03","end-date":"","notes":". Outline application for redevelopment of existing school site for the erection of 67 dwellings.","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"213","site-address":"Former Redemption Academy, Eliot Road","site-plan-url":"","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.909008","longitude":"-0.165296","hectares":"0.28","minimum-net-dwellings":"16","maximum-net-dwellings":"16","start-date":"2017-11-03","end-date":"","notes":". Recreation/Open space","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"214","site-address":"Fry Road day nursery, Fry Road","site-plan-url":"","deliverable":"","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.902424","longitude":"-0.170376","hectares":"0.29","minimum-net-dwellings":"6","maximum-net-dwellings":"6","start-date":"2017-11-03","end-date":"","notes":". Recreation/Open space\r\nAdjacent to wildlife site","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"107","site-address":"Ken Brown car showroom, Shephall Way","site-plan-url":"","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.898556","longitude":"-0.174298","hectares":"0.29","minimum-net-dwellings":"36","maximum-net-dwellings":"36","start-date":"2017-11-03","end-date":"","notes":". Potential contamination","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"701","site-address":"Kenilworth Close Neighbourhood Centre","site-plan-url":"","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.874824","longitude":"-0.166644","hectares":"0.63","minimum-net-dwellings":"65","maximum-net-dwellings":"65","start-date":"2017-11-03","end-date":"","notes":". Agricultural Land Grade 3","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"217","site-address":"Longfield Fire and Rescue","site-plan-url":"","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"pending decision","planning-permission-type":"","hazardous-substances":"","latitude":"51.918375","longitude":"-0.214195","hectares":"2.67","minimum-net-dwellings":"95","maximum-net-dwellings":"95","start-date":"2017-11-03","end-date":"","notes":". Outline planning application for residential development of up to 95 dwellings.","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"710","site-address":"Marymead Neighbourhood Centre","site-plan-url":"","deliverable":"","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.881836","longitude":"-0.178709","hectares":"0.54","minimum-net-dwellings":"60","maximum-net-dwellings":"60","start-date":"2017-11-03","end-date":"","notes":". Conservation Area","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"141","site-address":"Matalan","site-plan-url":"","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"outline planning permission","hazardous-substances":"","latitude":"51.900458","longitude":"-0.203844","hectares":"1.38","minimum-net-dwellings":"526","maximum-net-dwellings":"526","start-date":"2017-11-03","end-date":"","notes":". Application for outline permission for residential development of up to 526 residential apartments and commercial units Class A1 (retail) A2 (professional and financial) A3 (restaurant) and A4 (drinking establishments) and A5 (hot food take away) with associated access, parking and landscaping following demolition of existing buildings.. Potentially contaminated","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"126","site-address":"Park Place","site-plan-url":"","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"51.902741","longitude":"-0.20025","hectares":"0.5","minimum-net-dwellings":"202","maximum-net-dwellings":"202","start-date":"2017-11-03","end-date":"","notes":". Change of use of an existing three storey building from A1 (retail), B1 (office) and D1 (dental clinic) to retail and residential use and the construction of three additional floors for residential use comprising no. 44 studio units, no. 120 one bedroom residential units, and no. 38 two bedroom residential units.. Adjacent to a Conservation Area","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"BFR5","site-address":"Pond Close, 11 Walkern Road","site-plan-url":"","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"51.913587","longitude":"-0.207421","hectares":"0.78","minimum-net-dwellings":"12","maximum-net-dwellings":"12","start-date":"2017-11-03","end-date":"","notes":". Erection of 2no three storey blocks to provide 12no one bedroom flats, parking and landscaping","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"611","site-address":"Rugby Club, North Road","site-plan-url":"","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.926547","longitude":"-0.214089","hectares":"2.55","minimum-net-dwellings":"149","maximum-net-dwellings":"149","start-date":"2017-11-03","end-date":"","notes":". Potentially contaminated","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"212","site-address":"Scout Hut, Drakes Drive","site-plan-url":"","deliverable":"","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.912081","longitude":"-0.1709","hectares":"0.28","minimum-net-dwellings":"18","maximum-net-dwellings":"18","start-date":"2017-11-03","end-date":"","notes":". Potentially contaminated","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"","site-address":"Symonds Green NC","site-plan-url":"","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"pending decision","planning-permission-type":"","hazardous-substances":"","latitude":"51.913071","longitude":"-0.221995","hectares":"0.93","minimum-net-dwellings":"22","maximum-net-dwellings":"22","start-date":"2017-11-03","end-date":"","notes":". Demolition of 4 no. residential units and refurbishment and external alterations of neighbourhood centre, change of use of existing A1 (shop), B1/B8 (Former Council Estate Office, Business and Storage), D1 (Community Centre) and ancillary Community Cafe to create 3 no. units comprising 2no. Class A1 (shop) and 1no. Class B1 (business) at ground floor level, construction of one additional floor to create 12 no. one bedroom apartments and 10 no. two bedroom flats.","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"709","site-address":"The Glebe Neighbourhood Centre","site-plan-url":"","deliverable":"","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.909262","longitude":"-0.170025","hectares":"1.39","minimum-net-dwellings":"35","maximum-net-dwellings":"35","start-date":"2017-11-03","end-date":"","notes":". Potentially contaminated","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"703","site-address":"The Hyde Neighbourhood Centre","site-plan-url":"","deliverable":"","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.892366","longitude":"-0.169477","hectares":"1.23","minimum-net-dwellings":"50","maximum-net-dwellings":"50","start-date":"2017-11-03","end-date":"","notes":". Potentially contaminated","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"704","site-address":"The Oval Neighbourhood Centre","site-plan-url":"","deliverable":"","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.919182","longitude":"-0.179423","hectares":"1.81","minimum-net-dwellings":"275","maximum-net-dwellings":"275","start-date":"2017-11-03","end-date":"","notes":". Potentially contaminated","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"201","site-address":"The Shephall Centre, Shephall Green","site-plan-url":"","deliverable":"","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"51.890881","longitude":"-0.179245","hectares":"0.7","minimum-net-dwellings":"34","maximum-net-dwellings":"34","start-date":"2017-11-03","end-date":"","notes":". Area of Archeology","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"BFR7","site-address":"Town Centre","site-plan-url":"","deliverable":"","ownership":"mixed ownership","planning-permission-status":"","planning-permission-type":"","hazardous-substances":"","latitude":"","longitude":"","hectares":"51.69","minimum-net-dwellings":"2000","maximum-net-dwellings":"2000","start-date":"2017-11-03","end-date":"","notes":"","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"},{"entry-date":"2017-11-03","organisation":"local-authority-eng:STV","site":"Check if complete - started (SMART)\r\n002","site-address":"Vincent Court, Fishers Green Road","site-plan-url":"","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"reserved matters approval","hazardous-substances":"","latitude":"51.918255","longitude":"-0.218141","hectares":"1.13","minimum-net-dwellings":"37","maximum-net-dwellings":"37","start-date":"2017-11-03","end-date":"","notes":". Reserved matters application pursuant to outline planning permission 14/00178/OPM for the erection of 37 dwellings seeking approval of the access, appearance, landscaping, layout and scale","resource":"5bb6c53b732c87fb8912f0b327acf92fef4cb4c85754cb39e10953e7fa847120"}]
</script>

<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-sidebar@0.2.2/src/L.Control.Sidebar.js" crossorigin=""></script>
<script src="https://unpkg.com/papaparse@5.1.1/papaparse.min.js" crossorigin=""></script>

<script>
var map = L.map('map', {
  preferCanvas: true,
  fullscreenControl: true
}).setView([52.561928, -1.464854], 7)

// Tile layers
L.tileLayer('https://tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
  id: 'base',
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map)

// Sidebar
var sidebar = L.control.sidebar('sidebar', {
  position: 'right'
})

map.addControl(sidebar)

// Brownfield Features
var brownfieldFeatures = brownfield.map(function (point) {
  return {
    type: 'Feature',
    geometry: {
      type: 'Point',
      coordinates: [point.longitude, point.latitude]
    },
    properties: point
  }
})

// Local authority boundaries (England only)
geoJson = geoJson.features.filter(function (item) {
  return item.properties.lad19cd.startsWith('E')
}).map(function (item) {
  var lad19cd = item.properties.lad19cd
  if (item.properties.lad19cd === 'E06000057') {
    // Northumberland
    lad19cd = 'E06000048'
  } else if (item.properties.lad19cd === 'E07000240') {
    // St Albans
    lad19cd = 'E07000100'
  } else if (item.properties.lad19cd === 'E07000241') {
    // Welwyn Hatfield
    lad19cd = 'E07000104'
  } else if (item.properties.lad19cd === 'E07000242') {
    // East Hertfordshire
    lad19cd = 'E07000097'
  } else if (item.properties.lad19cd === 'E07000243') {
    // Stevenage
    lad19cd = 'E07000101'
  } else if (item.properties.lad19cd === 'E08000037') {
    // Gateshead
    lad19cd = 'E08000020'
  }

  item.properties.organisation = organisations.find(function (organisation) {
    if (organisation['statistical-geography'] && organisation['statistical-geography'].length) {
      return organisation['statistical-geography'].toString().toLowerCase() === lad19cd.toString().toLowerCase()
    }
  })

  return item
})

L.geoJSON(geoJson, {
  style: {
    fillOpacity: 0,
    weight: 2,
    color: 'gray'
  },
  onEachFeature: function (feature, layer) {
    if(organisations.length === 1) {
      map.fitBounds(layer.getBounds())
    }

    if (!feature.properties.organisation) {
      layer.setStyle({
        fillColor: 'red',
        fillOpacity: 0.25
      })
    } else {
      var thisOrganisationsFeatures = brownfieldFeatures.filter(function (brownfieldFeature) {
        if (brownfieldFeature.properties.organisation.toLowerCase() === feature.properties.organisation.organisation.toLowerCase()) {
          return true
        }
        return false
      })

      var brownfieldMarkers = L.markerClusterGroup({
        showCoverageOnHover: false,
        zoomToBoundsOnClick: false,
        spiderfyOnMaxZoom: false,
        removeOutsideVisibleBounds: true,
        animate: false,
        disableClusteringAtZoom: 11,
        maxClusterRadius: 600,
        singleMarkerMode: false
      })
      var brownfieldOnMap = L.geoJSON({
        type: 'FeatureCollection',
        features: thisOrganisationsFeatures
      }, {
        pointToLayer: function (feature, latlng) {
          var size = isNaN(feature.properties.hectares) ? 100 : (Math.sqrt((feature.properties.hectares * 10000) / Math.PI))
          return L.circle(latlng, { color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: size.toFixed(2) })
        },
        onEachFeature: function (feature, layer) {
          layer.on({
            click: function () {
              sidebar.setContent('<h2>Loading...</h2>')
              sidebar.show()

              return Papa.parse('https://raw.githubusercontent.com/digital-land/map/master/docs/data/brownfield/' + feature.properties.organisation.toLowerCase().replace(':', '-') + '.csv', {
                download: true,
                header: true,
                complete: function (results) {
                  var point = results.data.find(function (row) {
                    return (row.latitude === feature.properties.latitude.toString()) && (row.longitude === feature.properties.longitude.toString())
                  })

                  if (point) {
                    content = ''

                    Object.keys(point).forEach(function (key) {
                      content = content + key + ': ' + point[key] + '<br>'
                    })
                  } else {
                    content = '<h2>Point not found - debug info:</h2><pre>' + JSON.stringify(results.data) + '</pre><h3>Looking for a row with latitude, longitude:</h3>' + feature.properties.latitude.toString() + ',' + feature.properties.longitude.toString()
                  }

                  sidebar.setContent(content)
                }
              })
            }
          })
        }
      })

      brownfieldMarkers.addLayer(brownfieldOnMap)
      map.addLayer(brownfieldMarkers)
    }

    layer.on({
      mouseover: function () {
        this.setStyle({
          fillColor: 'black',
          fillOpacity: 0.25
        })
      },
      mouseout: function () {
        this.setStyle({
          fillColor: 'white',
          fillOpacity: 0
        })
      },
      click: function () {
        return map.fitBounds(layer.getBounds())
      }
    })
  }
}).addTo(map)
</script>

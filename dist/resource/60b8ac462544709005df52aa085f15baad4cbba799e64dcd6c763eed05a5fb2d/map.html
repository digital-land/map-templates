<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar@0.2.2/src/L.Control.Sidebar.css" crossorigin="" />

<style>
  body {
    margin: 0;
  }

  #map {
    width: 960px;
    height: 640px;
    transform: translate(-50%,-50%);
    position: absolute;
    top: 50%;
    left: 50%;
  }

  .leaflet-sidebar {
    display: none;
    width: 200px;
  }

  .leaflet-sidebar.visible {
    display: block;
  }

  .leaflet-sidebar .close {
    z-index: 10000;
  }

  .leaflet-marker-icon.marker-cluster {
    line-height: 18px;
    text-align: center;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    background: #fff;
    border: 2px solid #222;
  }
</style>

<div id="map"></div>
<div id="sidebar"></div>

<script>
  var geoJson = []
  var organisations = [{"organisation":"local-authority-eng:FOR","wikidata":"Q73072627","name":"Forest Heath District Council","website":"https://www.forest-heath.gov.uk","twitter":"","statistical-geography":"E07000201","toid":"","opendatacommunities":"http://opendatacommunities.org/id/district-council/forest-heath","opendatacommunities-area":"http://opendatacommunities.org/id/geography/administration/nmd/E07000201","billing-authority":"E3532","census-area":"42UC","local-authority-type":"NMD","esd-inventories":"","start-date":"1974-04-01","end-date":"2019-03-31"},{"organisation":"local-authority-eng:SED","wikidata":"Q73072776","name":"St Edmundsbury Borough Council","website":"https://www.stedmundsbury.gov.uk","twitter":"","statistical-geography":"E07000204","toid":"","opendatacommunities":"http://opendatacommunities.org/id/district-council/st-edmundsbury","opendatacommunities-area":"http://opendatacommunities.org/id/geography/administration/nmd/E07000204","billing-authority":"E3535","census-area":"42UF","local-authority-type":"NMD","esd-inventories":"","start-date":"","end-date":"2019-03-31"}]
  var brownfield = [{"entry-date":"2017-09-01","organisation":"local-authority-eng:FOR","site":"BF002","site-address":"LandOffTheGrove, BeckRow","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF002&StartZoom=500","deliverable":"yes","ownership":"","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.373531","longitude":"0.465348","hectares":"0.83","minimum-net-dwellings":"73","maximum-net-dwellings":"73","start-date":"2017-09-01","end-date":"","notes":"\"SHLAA REF BR/05\"\r\n\"SHLAA allocation Mixed use\". \"Brownfield -dwellings and grounds outside settlement boundary\". LINK TO SHLAA","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:FOR","site":"BF006","site-address":"WarrenClose, Brandon","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF006&StartZoom=500","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.446108","longitude":"0.626043","hectares":"0.39","minimum-net-dwellings":"23","maximum-net-dwellings":"23","start-date":"2017-09-01","end-date":"","notes":"\"SHLAA REF B/29\"\r\n\"SALP REF SA2(A) - residential\". \"Brownfield, previous library and preschool\". LINK TO SHLAA","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:FOR","site":"BF007","site-address":"LandOffGasHouseLane, Brandon","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF007&StartZoom=500","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"pending decision","planning-permission-type":"","hazardous-substances":"","latitude":"52.447832","longitude":"0.630605","hectares":"0.35","minimum-net-dwellings":"10","maximum-net-dwellings":"10","start-date":"2017-09-01","end-date":"","notes":"\"SHLAA REF B/31\"\r\n\"SALP REF SA2(b) - residential\"\r\n\"DC/16/1450/OUT - 10 dwellings; pending\". \"Brownfield, previous gasworks\". LINK TO SHLAA","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:FOR","site":"BF012","site-address":"Landrearof65, 69, 73StationRoad, Lakenheath","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF0012&StartZoom=500","deliverable":"yes","ownership":"","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.424065","longitude":"0.520855","hectares":"0.81","minimum-net-dwellings":"24","maximum-net-dwellings":"24","start-date":"2017-09-01","end-date":"","notes":"\"SHLAA REF L/03\". \"Brownfield- gardens within settlement boundary, but not town\". LINK TO SHLAA","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:FOR","site":"BF014","site-address":"MatthewsNurserySite, DumplingBridgeLane, Lakenheath","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF014&StartZoom=500","deliverable":"yes","ownership":"mixed ownership","planning-permission-status":"permissioned","planning-permission-type":"reserved matters approval","hazardous-substances":"","latitude":"52.418076","longitude":"0.51666","hectares":"1.86","minimum-net-dwellings":"13","maximum-net-dwellings":"13","start-date":"2017-09-01","end-date":"","notes":"\"F/2010/0337/OUT - 13 dwellings approved 28/02/12\"\r\n\"SHLAA REF L/29\"\r\n\"SALP REF \"SA7(a) - mixed\". \"Mixed - glasshouses and open land within settlement boundary\". LINK TO PLANNING APPLICATION","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:FOR","site":"BF015","site-address":"DistrictCouncilOffices, CollegeHeathRoad, Mildenhall","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF015&StartZoom=500","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.345744","longitude":"0.519068","hectares":"2.01","minimum-net-dwellings":"89","maximum-net-dwellings":"89","start-date":"2017-09-01","end-date":"","notes":"\"SHLAA REF M/46\"\r\n\"SALP REF SA5(b) - residential\". \"Brownfield- Council offices\". LINK TO SITE ALLOCATIONS LOCAL PLAN","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:FOR","site":"BF016","site-address":"LandAtWamilCourt, Mildenhall","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF016&StartZoom=500","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.342092","longitude":"0.50434","hectares":"0.62","minimum-net-dwellings":"19","maximum-net-dwellings":"19","start-date":"2017-09-01","end-date":"","notes":"\"SHLAA REF M/47\". \"Brownfield - care home\". LINK TO SHLAA","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:FOR","site":"BF019","site-address":"FormerSwimmingPoolSite, Newmarket","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF019&StartZoom=500","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.241325","longitude":"0.397764","hectares":"0.26","minimum-net-dwellings":"14","maximum-net-dwellings":"14","start-date":"2017-09-01","end-date":"","notes":"\"SHLAA REF N/29\"\r\n\"SALP REF \"SA6(b) - mixed\"\r\n\"Planning application for 7 units relates to part of site at Public House\". \"Brownfield - old swimming pool site and disused public house within settlement boundary\". LINK TO PLANNING APPLICATION","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:FOR","site":"BF020","site-address":"StFelixMiddleSchoolSite, Newmarket","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF020&StartZoom=500","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.256971","longitude":"0.40085","hectares":"1.39","minimum-net-dwellings":"50","maximum-net-dwellings":"50","start-date":"2017-09-01","end-date":"","notes":"\"SHLAA REF N/32\"\r\n\"SHLAA allocation Mixed use\". \"Mixed - playingfields, outbuildings assoc with school, in settlement boundary\". LINK TO SHLAA","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:FOR","site":"BF021","site-address":"LandOffTurnpikeRoad, RedLodge","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF021&StartZoom=500","deliverable":"yes","ownership":"mixed ownership","planning-permission-status":"pending decision","planning-permission-type":"","hazardous-substances":"","latitude":"52.30318","longitude":"0.482736","hectares":"2.56","minimum-net-dwellings":"132","maximum-net-dwellings":"132","start-date":"2017-09-01","end-date":"","notes":"\"Planning application is for 55 dwellings\"\r\n\"SHLAA REF RL/03\"\r\n\"SALP REF SA9(a) - residential\"\r\n\"SHLAA allocation Mixed use\". \"Mixed - residential, haulage depot, mobile home park, garage\". LINK TO SITE ALLOCATIONS LOCAL PLAN","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:FOR","site":"BF027","site-address":"LandOffPottHallRoad, WestRow","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF027&StartZoom=500","deliverable":"yes","ownership":"mixed ownership","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.34965","longitude":"0.467807","hectares":"0.55","minimum-net-dwellings":"174","maximum-net-dwellings":"174","start-date":"2017-09-01","end-date":"","notes":"\"SHLAA REF WR/25\"\r\n\"SHLAA allocation Mixed use\". \"Mixed - agricultural and residential within settlement boundary\". LINK TO SHLAA","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:SED","site":"BF031","site-address":"BuryStEdmundsGardenCentre, BuryStEdmunds","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF033&StartZoom=500","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.235426","longitude":"0.729252","hectares":"1.37","minimum-net-dwellings":"30","maximum-net-dwellings":"30","start-date":"2017-09-01","end-date":"","notes":"\"VISION 2031 REF BV10A\". \"Brownfield - garden centre\". LINK TO VISION 2031","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:SED","site":"BF032","site-address":"GaragesAndBusDepot, CottonLane, BuryStEdmunds","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF034&StartZoom=500","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.24697","longitude":"0.719236","hectares":"0.65","minimum-net-dwellings":"50","maximum-net-dwellings":"50","start-date":"2017-09-01","end-date":"","notes":"\"SE/12/1468/FUL Partial COU showroom\"\r\n\"VISION 2031 BV10h\". \"Brownfield - bus depot and car repairs/ dealership\". LINK TO VISION 2031","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:SED","site":"BF033","site-address":"HospitalSite, HospitalRoad, BuryStEdmunds","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF035&StartZoom=500","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.24187","longitude":"0.702883","hectares":"1.59","minimum-net-dwellings":"45","maximum-net-dwellings":"45","start-date":"2017-09-01","end-date":"","notes":"\"VISION 2031 BV10c\". \"Brownfield - hospital\". LINK TO VISION 2031","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:SED","site":"BF035","site-address":"LandAtRamMeadow, BuryStEdmunds","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF036&StartZoom=500","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.248864","longitude":"0.720978","hectares":"0.98","minimum-net-dwellings":"84","maximum-net-dwellings":"84","start-date":"2017-09-01","end-date":"","notes":"\"VISION 2031 BV11\"\r\n\"SHLAA allocation Mixed use\". \"Mixed - carpark, meadow and football ground\". LINK TO VISION 2031","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:SED","site":"BF037","site-address":"SchoolYard, BuryStEdmunds","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF037&StartZoom=500","deliverable":"yes","ownership":"mixed ownership","planning-permission-status":"not permissioned","planning-permission-type":"other","hazardous-substances":"","latitude":"52.246705","longitude":"0.709667","hectares":"0.28","minimum-net-dwellings":"32","maximum-net-dwellings":"32","start-date":"2017-09-01","end-date":"","notes":"\"Planning permission SE/04/2197/P approved and lapsed.\" \r\n\"VISION 2031 BV10f\". \"Brownfield  - auctioneers and car park\". LINK TO VISION 2031","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:SED","site":"BF039","site-address":"StationHill, BuryStEdmunds","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF039&StartZoom=500","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"pending decision","planning-permission-type":"","hazardous-substances":"","latitude":"52.252589","longitude":"0.712297","hectares":"1.41","minimum-net-dwellings":"300","maximum-net-dwellings":"300","start-date":"2017-09-01","end-date":"","notes":"\"Partial - DC/15/1520/FUL 14 apartments and 28 dwellings; pending\"\r\n\"VISION 2031 BV8\". \"Brownfield - underused railway sidings and vacant land\". LINK TO VISION 2031","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:SED","site":"BF040","site-address":"TayfenRoad, BuryStEdmunds","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF040&StartZoom=500","deliverable":"yes","ownership":"mixed ownership","planning-permission-status":"pending decision","planning-permission-type":"","hazardous-substances":"","latitude":"52.251035","longitude":"0.709067","hectares":"2.2","minimum-net-dwellings":"100","maximum-net-dwellings":"100","start-date":"2017-09-01","end-date":"","notes":"\"DC/15/0689/OUT 215 dwellings and 60 bed care home; pending\"\r\n\"VISION 2031 BV9\". \"Brownfield - commercial/ vacant uses and decommissioned gas holder\". LINK TO VISION 2031","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:SED","site":"BF041","site-address":"WeymedSite, BuryStEdmunds","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF041&StartZoom=500","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.241827","longitude":"0.719229","hectares":"0.37","minimum-net-dwellings":"14","maximum-net-dwellings":"14","start-date":"2017-09-01","end-date":"","notes":"\"SE/12/0451/FULCA - 15 dwellings approved 19/03/13 - lapsed\"\r\n\"DC/17/1645/CLE submitted to determine lawful commencement of development - granted\"\r\n\"VISION 2031 BV10e\". \"Brownfield - vacant County council offices\". LINK TO VISION 2031","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:SED","site":"BF042","site-address":"AttertonAndEllisSite, Haverhill","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF042&StartZoom=500","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.077381","longitude":"0.446935","hectares":"0.4","minimum-net-dwellings":"39","maximum-net-dwellings":"39","start-date":"2017-09-01","end-date":"","notes":"\"SE/06/1504 conversion of mill to 3 dwellings, erection 31 flats and 5 houses approved 30/04/10 - planning application lapsed\". \"Brownfield - engineering works\". LINK TO PLANNING APPLICATION","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:SED","site":"BF044","site-address":"FormerGasworks, WithersfieldRoad, Haverhill","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF044&StartZoom=500","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.087256","longitude":"0.433812","hectares":"0.25","minimum-net-dwellings":"10","maximum-net-dwellings":"10","start-date":"2017-09-01","end-date":"","notes":"\"site remediation application approved\"\r\n\"VISION 2031 HV6a\". \"Brownfield - gasworks\". LINK TO VISION 2031","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"},{"entry-date":"2017-09-01","organisation":"local-authority-eng:SED","site":"BF045","site-address":"FormerWestfieldPrimarySchool, ManorRoad, Haverhill","site-plan-url":"http://maps.westsuffolk.gov.uk/MyWestSuffolk.aspx?MapSource=WestSuffolk/AllMapsTest&SearchLayer=brownfield&SearchField=brownfield_ref&SearchValue=BF045&StartZoom=500","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.080966","longitude":"0.449218","hectares":"0.44","minimum-net-dwellings":"30","maximum-net-dwellings":"30","start-date":"2017-09-01","end-date":"","notes":"\"demolition of former school - SE/13/0289/CR3\"\r\n\"VISION 2031 HV6c\"\r\n\"SHLAA allocation Mixed use\". \"Brownfield - previous school\". LINK TO VISION 2031","resource":"60b8ac462544709005df52aa085f15baad4cbba799e64dcd6c763eed05a5fb2d"}]
</script>

<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-sidebar@0.2.2/src/L.Control.Sidebar.js" crossorigin=""></script>
<script src="https://unpkg.com/papaparse@5.1.1/papaparse.min.js" crossorigin=""></script>

<script>
var map = L.map('map', {
  preferCanvas: true,
  fullscreenControl: true
}).setView([52.561928, -1.464854], 7)

// Tile layers
L.tileLayer('https://tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
  id: 'base',
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map)

// Sidebar
var sidebar = L.control.sidebar('sidebar', {
  position: 'right'
})

map.addControl(sidebar)

// Brownfield Features
var brownfieldFeatures = brownfield.map(function (point) {
  return {
    type: 'Feature',
    geometry: {
      type: 'Point',
      coordinates: [point.longitude, point.latitude]
    },
    properties: point
  }
})

// Local authority boundaries (England only)
geoJson = geoJson.features.filter(function (item) {
  return item.properties.lad19cd.startsWith('E')
}).map(function (item) {
  var lad19cd = item.properties.lad19cd
  if (item.properties.lad19cd === 'E06000057') {
    // Northumberland
    lad19cd = 'E06000048'
  } else if (item.properties.lad19cd === 'E07000240') {
    // St Albans
    lad19cd = 'E07000100'
  } else if (item.properties.lad19cd === 'E07000241') {
    // Welwyn Hatfield
    lad19cd = 'E07000104'
  } else if (item.properties.lad19cd === 'E07000242') {
    // East Hertfordshire
    lad19cd = 'E07000097'
  } else if (item.properties.lad19cd === 'E07000243') {
    // Stevenage
    lad19cd = 'E07000101'
  } else if (item.properties.lad19cd === 'E08000037') {
    // Gateshead
    lad19cd = 'E08000020'
  }

  item.properties.organisation = organisations.find(function (organisation) {
    if (organisation['statistical-geography'] && organisation['statistical-geography'].length) {
      return organisation['statistical-geography'].toString().toLowerCase() === lad19cd.toString().toLowerCase()
    }
  })

  return item
})

L.geoJSON(geoJson, {
  style: {
    fillOpacity: 0,
    weight: 2,
    color: 'gray'
  },
  onEachFeature: function (feature, layer) {
    if(organisations.length === 1) {
      map.fitBounds(layer.getBounds())
    }

    if (!feature.properties.organisation) {
      layer.setStyle({
        fillColor: 'red',
        fillOpacity: 0.25
      })
    } else {
      var thisOrganisationsFeatures = brownfieldFeatures.filter(function (brownfieldFeature) {
        if (brownfieldFeature.properties.organisation.toLowerCase() === feature.properties.organisation.organisation.toLowerCase()) {
          return true
        }
        return false
      })

      var brownfieldMarkers = L.markerClusterGroup({
        showCoverageOnHover: false,
        zoomToBoundsOnClick: false,
        spiderfyOnMaxZoom: false,
        removeOutsideVisibleBounds: true,
        animate: false,
        disableClusteringAtZoom: 11,
        maxClusterRadius: 600,
        singleMarkerMode: false
      })
      var brownfieldOnMap = L.geoJSON({
        type: 'FeatureCollection',
        features: thisOrganisationsFeatures
      }, {
        pointToLayer: function (feature, latlng) {
          var size = isNaN(feature.properties.hectares) ? 100 : (Math.sqrt((feature.properties.hectares * 10000) / Math.PI))
          return L.circle(latlng, { color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: size.toFixed(2) })
        },
        onEachFeature: function (feature, layer) {
          layer.on({
            click: function () {
              sidebar.setContent('<h2>Loading...</h2>')
              sidebar.show()

              return Papa.parse('https://raw.githubusercontent.com/digital-land/map/master/docs/data/brownfield/' + feature.properties.organisation.toLowerCase().replace(':', '-') + '.csv', {
                download: true,
                header: true,
                complete: function (results) {
                  var point = results.data.find(function (row) {
                    return (row.latitude === feature.properties.latitude.toString()) && (row.longitude === feature.properties.longitude.toString())
                  })

                  if (point) {
                    content = ''

                    Object.keys(point).forEach(function (key) {
                      content = content + key + ': ' + point[key] + '<br>'
                    })
                  } else {
                    content = '<h2>Point not found - debug info:</h2><pre>' + JSON.stringify(results.data) + '</pre><h3>Looking for a row with latitude, longitude:</h3>' + feature.properties.latitude.toString() + ',' + feature.properties.longitude.toString()
                  }

                  sidebar.setContent(content)
                }
              })
            }
          })
        }
      })

      brownfieldMarkers.addLayer(brownfieldOnMap)
      map.addLayer(brownfieldMarkers)
    }

    layer.on({
      mouseover: function () {
        this.setStyle({
          fillColor: 'black',
          fillOpacity: 0.25
        })
      },
      mouseout: function () {
        this.setStyle({
          fillColor: 'white',
          fillOpacity: 0
        })
      },
      click: function () {
        return map.fitBounds(layer.getBounds())
      }
    })
  }
}).addTo(map)
</script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar@0.2.2/src/L.Control.Sidebar.css" crossorigin="" />

<style>
  body {
    margin: 0;
  }

  #map {
    width: 960px;
    height: 640px;
    transform: translate(-50%,-50%);
    position: absolute;
    top: 50%;
    left: 50%;
  }

  .leaflet-sidebar {
    display: none;
    width: 200px;
  }

  .leaflet-sidebar.visible {
    display: block;
  }

  .leaflet-sidebar .close {
    z-index: 10000;
  }

  .leaflet-marker-icon.marker-cluster {
    line-height: 18px;
    text-align: center;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    background: #fff;
    border: 2px solid #222;
  }
</style>

<div id="map"></div>
<div id="sidebar"></div>

<script>
  var geoJson = []
  var organisations = [{"organisation":"local-authority-eng:WSO","wikidata":"Q73072834","name":"West Somerset District Council","website":"https://www.westsomersetonline.gov.uk","twitter":"","statistical-geography":"E07000191","toid":"","opendatacommunities":"http://opendatacommunities.org/id/district-council/west-somerset","opendatacommunities-area":"http://opendatacommunities.org/id/geography/administration/nmd/E07000191","billing-authority":"E3335","census-area":"40UF","local-authority-type":"NMD","esd-inventories":"","start-date":"","end-date":"2019-03-31"}]
  var brownfield = [{"entry-date":"2017-12-31","organisation":"local-authority-eng:WSO","site":"3/21/14/040","site-address":"52 The Avenue, Minehead, TA24 5BB","site-plan-url":"https://www.westsomersetonline.gov.uk/Docs/Brownfield-Register/52-The-Avenue-Minehead","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"51.206442","longitude":"-3.471904","hectares":"0.07","minimum-net-dwellings":"6","maximum-net-dwellings":"6","start-date":"2017-12-31","end-date":"","notes":". Conversion of existing multiple occupancy home, (HMO) consisting of 13 rooms and 1 flat, into 7 flats. Demolition of the existing ground and first floor rear extension, and construction of new, smaller extension rebuilt on first floor. Renovation and restoration of original exterior details and associated hard and soft landscaping","resource":"dac891e716aaf4874186d17446303577251118720a8416759aa19ea0d9d260d3"},{"entry-date":"2017-12-31","organisation":"local-authority-eng:WSO","site":"3/21/14/042","site-address":"Rear of 52 The Avenue, Minehead, TA24 5BB","site-plan-url":"https://www.westsomersetonline.gov.uk/Docs/Brownfield-Register/Rear-of-52-The-Avenue-Minehead","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"51.20622","longitude":"-3.471725","hectares":"0.04","minimum-net-dwellings":"5","maximum-net-dwellings":"5","start-date":"2017-12-31","end-date":"","notes":". Erection of five \"mews\" houses with associated car parking, refuse store, cycle store and associated hard and soft landscaping","resource":"dac891e716aaf4874186d17446303577251118720a8416759aa19ea0d9d260d3"},{"entry-date":"2017-12-31","organisation":"local-authority-eng:WSO","site":"3/21/15/113","site-address":"The Old Hospital, The Avenue, Minehead, TA24 5LY","site-plan-url":"https://www.westsomersetonline.gov.uk/Docs/Brownfield-Register/The-Old-Hospital-The-Avenue-Minehead","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"51.206129","longitude":"-3.47679","hectares":"0.26","minimum-net-dwellings":"4","maximum-net-dwellings":"4","start-date":"2017-12-31","end-date":"","notes":". Change of use from community hospital (Class C2) to community hub (Class D1), Assembly Room (Class D2), caf√© (Class A3) four apartments (Class C3), associated parking and public open space","resource":"dac891e716aaf4874186d17446303577251118720a8416759aa19ea0d9d260d3"},{"entry-date":"2017-12-31","organisation":"local-authority-eng:WSO","site":"3/21/16/115","site-address":"Tikoh and Rosslea, Bircham Road, Minehead, TA24 6BQ","site-plan-url":"https://www.westsomersetonline.gov.uk/Docs/Brownfield-Register/Tikoh-and-Rosslea-Bircham-Road-Minehead","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"51.195294","longitude":"-3.463849","hectares":"0.1","minimum-net-dwellings":"10","maximum-net-dwellings":"10","start-date":"2017-12-31","end-date":"","notes":". Demolition of houses and erection of an assisted housing development to provide 11 self-contained one bedroom living units with housekeeper accommodation, car park and ancillary facilities","resource":"dac891e716aaf4874186d17446303577251118720a8416759aa19ea0d9d260d3"},{"entry-date":"2017-12-31","organisation":"local-authority-eng:WSO","site":"3/28/16/002","site-address":"Land at Union Quarry, Tower Hill, Williton, Taunton, TA4 4JR","site-plan-url":"https://www.westsomersetonline.gov.uk/Docs/Brownfield-Register/Land-at-Union-Quarry-Tower-Hill-Williton","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"51.157671","longitude":"-3.312949","hectares":"0.29","minimum-net-dwellings":"1","maximum-net-dwellings":"1","start-date":"2017-12-31","end-date":"","notes":". Erection of dwellinghouse (Class C3) together with provision of garden and manoeuvring area","resource":"dac891e716aaf4874186d17446303577251118720a8416759aa19ea0d9d260d3"},{"entry-date":"2017-12-31","organisation":"local-authority-eng:WSO","site":"3/32/14/004","site-address":"Land at and adjoining 16 Castle Street, Stogursey, Bridgwater, TA5 1TG","site-plan-url":"https://www.westsomersetonline.gov.uk/Docs/Brownfield-Register/16-Castle-Street-Stogursey-(1)","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"51.178041","longitude":"-3.141366","hectares":"0.26","minimum-net-dwellings":"11","maximum-net-dwellings":"11","start-date":"2017-12-31","end-date":"","notes":". Demolition of existing bungalow and redundant agricultural building and construction of 12 new dwellings, associated parking and turning and improvements to existing vehicular entrance","resource":"dac891e716aaf4874186d17446303577251118720a8416759aa19ea0d9d260d3"},{"entry-date":"2017-12-31","organisation":"local-authority-eng:WSO","site":"3/37/08/036","site-address":"The Mill, Anchor Street, Watchet, TA23 0AZ","site-plan-url":"https://www.westsomersetonline.gov.uk/Docs/Brownfield-Register/The-Mill-Anchor-Street-Watchet","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"51.179635","longitude":"-3.333202","hectares":"0.94","minimum-net-dwellings":"10","maximum-net-dwellings":"10","start-date":"2017-12-31","end-date":"","notes":". Conversion of commercial units into 10 residential units, erection of a 70 bedroom care home, redesigned access & associated works","resource":"dac891e716aaf4874186d17446303577251118720a8416759aa19ea0d9d260d3"},{"entry-date":"2017-12-31","organisation":"local-authority-eng:WSO","site":"3/39/16/007","site-address":"Land at Larviscombe Road, Williton, TA4 4SA","site-plan-url":"https://www.westsomersetonline.gov.uk/Docs/Brownfield-Register/Land-at-Larviscombe-Road-Williton","deliverable":"","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"51.165416","longitude":"-3.319877","hectares":"0.13","minimum-net-dwellings":"3","maximum-net-dwellings":"3","start-date":"2017-12-31","end-date":"","notes":". Erection of three terrace dwellings with associated vehicle parking and gardens","resource":"dac891e716aaf4874186d17446303577251118720a8416759aa19ea0d9d260d3"},{"entry-date":"2018-05-22","organisation":"local-authority-eng:WSO","site":"SHLAAMHD5","site-address":"Minehead and Exmoor Caravan and Camping Park, Middlecombe Cross, Minehead, TA24 8SW","site-plan-url":"https://www.westsomersetonline.gov.uk/Docs/Brownfield-Register/Minehead-and-Exmoor-Caravan-and-Camping-Park-Middl","deliverable":"","ownership":"","planning-permission-status":"","planning-permission-type":"","hazardous-substances":"","latitude":"51.201253","longitude":"-3.50373","hectares":"1.2","minimum-net-dwellings":"20","maximum-net-dwellings":"20","start-date":"","end-date":"","notes":"","resource":"dac891e716aaf4874186d17446303577251118720a8416759aa19ea0d9d260d3"},{"entry-date":"2018-05-22","organisation":"local-authority-eng:WSO","site":"SHLAAMHD16","site-address":"Staunton Quarry, Alcombe, Minehead, TA24 6EE","site-plan-url":"https://www.westsomersetonline.gov.uk/Docs/Brownfield-Register/Staunton-Quarry-Alcombe-Minehead","deliverable":"","ownership":"","planning-permission-status":"","planning-permission-type":"","hazardous-substances":"","latitude":"","longitude":"","hectares":"2.23","minimum-net-dwellings":"50","maximum-net-dwellings":"50","start-date":"","end-date":"","notes":"","resource":"dac891e716aaf4874186d17446303577251118720a8416759aa19ea0d9d260d3"},{"entry-date":"2018-05-22","organisation":"local-authority-eng:WSO","site":"SHLAAMHD17","site-address":"Kingsway Hotel, Ponsford Road, Minehead, TA24 5DY","site-plan-url":"https://www.westsomersetonline.gov.uk/Docs/Brownfield-Register/Kingsway-Hotel-Ponsford-Road-Minehead","deliverable":"","ownership":"","planning-permission-status":"","planning-permission-type":"","hazardous-substances":"","latitude":"51.201175","longitude":"-3.470963","hectares":"0.1","minimum-net-dwellings":"","maximum-net-dwellings":"","start-date":"","end-date":"","notes":"","resource":"dac891e716aaf4874186d17446303577251118720a8416759aa19ea0d9d260d3"},{"entry-date":"2018-05-22","organisation":"local-authority-eng:WSO","site":"SHLAAMHD18","site-address":"Culvercliffe, Minehead, TA24 5UN","site-plan-url":"https://www.westsomersetonline.gov.uk/Docs/Brownfield-Register/Culvercliffe-Minehead","deliverable":"","ownership":"","planning-permission-status":"","planning-permission-type":"","hazardous-substances":"","latitude":"51.214877","longitude":"-3.476927","hectares":"1.6","minimum-net-dwellings":"35","maximum-net-dwellings":"35","start-date":"","end-date":"","notes":"","resource":"dac891e716aaf4874186d17446303577251118720a8416759aa19ea0d9d260d3"},{"entry-date":"2018-05-22","organisation":"local-authority-eng:WSO","site":"SHLAAWW2","site-address":"Wansborough Paper Mill, Watchet, TA23 0AY","site-plan-url":"https://www.westsomersetonline.gov.uk/Docs/Brownfield-Register/Wansborough-Paper-Mill-Watchet","deliverable":"","ownership":"","planning-permission-status":"","planning-permission-type":"","hazardous-substances":"","latitude":"51.176015","longitude":"-3.343083","hectares":"17","minimum-net-dwellings":"","maximum-net-dwellings":"","start-date":"","end-date":"","notes":"","resource":"dac891e716aaf4874186d17446303577251118720a8416759aa19ea0d9d260d3"}]
</script>

<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-sidebar@0.2.2/src/L.Control.Sidebar.js" crossorigin=""></script>
<script src="https://unpkg.com/papaparse@5.1.1/papaparse.min.js" crossorigin=""></script>

<script>
var map = L.map('map', {
  preferCanvas: true,
  fullscreenControl: true
}).setView([52.561928, -1.464854], 7)

// Tile layers
L.tileLayer('https://tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
  id: 'base',
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map)

// Sidebar
var sidebar = L.control.sidebar('sidebar', {
  position: 'right'
})

map.addControl(sidebar)

// Brownfield Features
var brownfieldFeatures = brownfield.map(function (point) {
  return {
    type: 'Feature',
    geometry: {
      type: 'Point',
      coordinates: [point.longitude, point.latitude]
    },
    properties: point
  }
})

// Local authority boundaries (England only)
geoJson = geoJson.features.filter(function (item) {
  return item.properties.lad19cd.startsWith('E')
}).map(function (item) {
  var lad19cd = item.properties.lad19cd
  if (item.properties.lad19cd === 'E06000057') {
    // Northumberland
    lad19cd = 'E06000048'
  } else if (item.properties.lad19cd === 'E07000240') {
    // St Albans
    lad19cd = 'E07000100'
  } else if (item.properties.lad19cd === 'E07000241') {
    // Welwyn Hatfield
    lad19cd = 'E07000104'
  } else if (item.properties.lad19cd === 'E07000242') {
    // East Hertfordshire
    lad19cd = 'E07000097'
  } else if (item.properties.lad19cd === 'E07000243') {
    // Stevenage
    lad19cd = 'E07000101'
  } else if (item.properties.lad19cd === 'E08000037') {
    // Gateshead
    lad19cd = 'E08000020'
  }

  item.properties.organisation = organisations.find(function (organisation) {
    if (organisation['statistical-geography'] && organisation['statistical-geography'].length) {
      return organisation['statistical-geography'].toString().toLowerCase() === lad19cd.toString().toLowerCase()
    }
  })

  return item
})

L.geoJSON(geoJson, {
  style: {
    fillOpacity: 0,
    weight: 2,
    color: 'gray'
  },
  onEachFeature: function (feature, layer) {
    if(organisations.length === 1) {
      map.fitBounds(layer.getBounds())
    }

    if (!feature.properties.organisation) {
      layer.setStyle({
        fillColor: 'red',
        fillOpacity: 0.25
      })
    } else {
      var thisOrganisationsFeatures = brownfieldFeatures.filter(function (brownfieldFeature) {
        if (brownfieldFeature.properties.organisation.toLowerCase() === feature.properties.organisation.organisation.toLowerCase()) {
          return true
        }
        return false
      })

      var brownfieldMarkers = L.markerClusterGroup({
        showCoverageOnHover: false,
        zoomToBoundsOnClick: false,
        spiderfyOnMaxZoom: false,
        removeOutsideVisibleBounds: true,
        animate: false,
        disableClusteringAtZoom: 11,
        maxClusterRadius: 600,
        singleMarkerMode: false
      })
      var brownfieldOnMap = L.geoJSON({
        type: 'FeatureCollection',
        features: thisOrganisationsFeatures
      }, {
        pointToLayer: function (feature, latlng) {
          var size = isNaN(feature.properties.hectares) ? 100 : (Math.sqrt((feature.properties.hectares * 10000) / Math.PI))
          return L.circle(latlng, { color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: size.toFixed(2) })
        },
        onEachFeature: function (feature, layer) {
          layer.on({
            click: function () {
              sidebar.setContent('<h2>Loading...</h2>')
              sidebar.show()

              return Papa.parse('https://raw.githubusercontent.com/digital-land/map/master/docs/data/brownfield/' + feature.properties.organisation.toLowerCase().replace(':', '-') + '.csv', {
                download: true,
                header: true,
                complete: function (results) {
                  var point = results.data.find(function (row) {
                    return (row.latitude === feature.properties.latitude.toString()) && (row.longitude === feature.properties.longitude.toString())
                  })

                  if (point) {
                    content = ''

                    Object.keys(point).forEach(function (key) {
                      content = content + key + ': ' + point[key] + '<br>'
                    })
                  } else {
                    content = '<h2>Point not found - debug info:</h2><pre>' + JSON.stringify(results.data) + '</pre><h3>Looking for a row with latitude, longitude:</h3>' + feature.properties.latitude.toString() + ',' + feature.properties.longitude.toString()
                  }

                  sidebar.setContent(content)
                }
              })
            }
          })
        }
      })

      brownfieldMarkers.addLayer(brownfieldOnMap)
      map.addLayer(brownfieldMarkers)
    }

    layer.on({
      mouseover: function () {
        this.setStyle({
          fillColor: 'black',
          fillOpacity: 0.25
        })
      },
      mouseout: function () {
        this.setStyle({
          fillColor: 'white',
          fillOpacity: 0
        })
      },
      click: function () {
        return map.fitBounds(layer.getBounds())
      }
    })
  }
}).addTo(map)
</script>

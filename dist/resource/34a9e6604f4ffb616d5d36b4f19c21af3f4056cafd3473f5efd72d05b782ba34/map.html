<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar@0.2.2/src/L.Control.Sidebar.css" crossorigin="" />

<style>
  body {
    margin: 0;
  }

  #map {
    width: 960px;
    height: 640px;
    transform: translate(-50%,-50%);
    position: absolute;
    top: 50%;
    left: 50%;
  }

  .leaflet-sidebar {
    display: none;
    width: 200px;
  }

  .leaflet-sidebar.visible {
    display: block;
  }

  .leaflet-sidebar .close {
    z-index: 10000;
  }

  .leaflet-marker-icon.marker-cluster {
    line-height: 18px;
    text-align: center;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    background: #fff;
    border: 2px solid #222;
  }
</style>

<div id="map"></div>
<div id="sidebar"></div>

<script>
  var geoJson = []
  var organisations = [{"organisation":"local-authority-eng:SUF","wikidata":"Q73072783","name":"Suffolk Coastal District Council","website":"https://www.suffolkcoastal.gov.uk","twitter":"","statistical-geography":"E07000205","toid":"","opendatacommunities":"http://opendatacommunities.org/id/district-council/suffolk-coastal","opendatacommunities-area":"http://opendatacommunities.org/id/geography/administration/nmd/E07000205","billing-authority":"E3536","census-area":"42UG","local-authority-type":"NMD","esd-inventories":"","start-date":"","end-date":"2019-03-31"}]
  var brownfield = [{"entry-date":"2017-12-01","organisation":"local-authority-eng:SUF","site":"SCDC001","site-address":"Land at Felixstowe Sunday Market site Sea Road","site-plan-url":"http://waveney.maps.arcgis.com/apps/MapJournal/index.html?appid=1a787ff0d2604387987c86ac1ae56188","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"pending decision","planning-permission-type":"","hazardous-substances":"","latitude":"51.952098","longitude":"1.337876","hectares":"0.58","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-12-01","end-date":"","notes":". Erection of building containing 48 flats over ground floor commercial units. Erection of 11 houses (includes new private access road, parking and external works).","resource":"34a9e6604f4ffb616d5d36b4f19c21af3f4056cafd3473f5efd72d05b782ba34"},{"entry-date":"2017-12-01","organisation":"local-authority-eng:SUF","site":"SCDC002","site-address":"Old Station Works Westerfield Road Westerfield Ipswich IP6 9AB","site-plan-url":"http://waveney.maps.arcgis.com/apps/MapJournal/index.html?appid=1a787ff0d2604387987c86ac1ae56188","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"outline planning permission","hazardous-substances":"","latitude":"52.082148","longitude":"1.169579","hectares":"3.65","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-12-01","end-date":"","notes":". Outline permission for the redevelopment of the site for a mixed use scheme comprising 1,120 sqm of office floorspace, 35 dwellings (12 affordable), 160sqm community floorspace, publicly accessible open space and associated works.","resource":"34a9e6604f4ffb616d5d36b4f19c21af3f4056cafd3473f5efd72d05b782ba34"},{"entry-date":"2017-12-01","organisation":"local-authority-eng:SUF","site":"SCDC003","site-address":"Street Farm The Street Witnesham Ipswich IP6 9HG","site-plan-url":"http://waveney.maps.arcgis.com/apps/MapJournal/index.html?appid=1a787ff0d2604387987c86ac1ae56188","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"52.10552","longitude":"1.187713","hectares":"0.71","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-12-01","end-date":"","notes":"","resource":"34a9e6604f4ffb616d5d36b4f19c21af3f4056cafd3473f5efd72d05b782ba34"},{"entry-date":"2017-12-01","organisation":"local-authority-eng:SUF","site":"SCDC004","site-address":"Garage site Langer Road Felixstowe IP11 2HS","site-plan-url":"http://waveney.maps.arcgis.com/apps/MapJournal/index.html?appid=1a787ff0d2604387987c86ac1ae56188","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"51.955499","longitude":"1.337852","hectares":"0.15","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-12-01","end-date":"","notes":". Erection of 5 dwellings and alterations to existing vehicular access","resource":"34a9e6604f4ffb616d5d36b4f19c21af3f4056cafd3473f5efd72d05b782ba34"},{"entry-date":"2017-12-01","organisation":"local-authority-eng:SUF","site":"SCDC005","site-address":"Penfold Road Felixstowe Suffolk IP11 7BP","site-plan-url":"http://waveney.maps.arcgis.com/apps/MapJournal/index.html?appid=1a787ff0d2604387987c86ac1ae56188","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"outline planning permission","hazardous-substances":"","latitude":"51.965035","longitude":"1.351361","hectares":"0.12","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-12-01","end-date":"","notes":". Demolition of existing building and construction of 5 dwellings with access and garaging (Outline)","resource":"34a9e6604f4ffb616d5d36b4f19c21af3f4056cafd3473f5efd72d05b782ba34"},{"entry-date":"2017-12-01","organisation":"local-authority-eng:SUF","site":"SCDC006","site-address":"38-40 Victoria Street Felixstowe Suffolk IP11 7EW","site-plan-url":"http://waveney.maps.arcgis.com/apps/MapJournal/index.html?appid=1a787ff0d2604387987c86ac1ae56188","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"51.962774","longitude":"1.35275","hectares":"0.08","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-12-01","end-date":"","notes":". Conversion of redundant buildings to new dwellings, erection of new flat to site frontage and erection of car ports and associated car parking","resource":"34a9e6604f4ffb616d5d36b4f19c21af3f4056cafd3473f5efd72d05b782ba34"},{"entry-date":"2017-12-01","organisation":"local-authority-eng:SUF","site":"SCDC007","site-address":"Former The Buregate Public House Sea Road Felixstowe Suffolk IP11 2DD","site-plan-url":"http://waveney.maps.arcgis.com/apps/MapJournal/index.html?appid=1a787ff0d2604387987c86ac1ae56188","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"51.955253","longitude":"1.34143","hectares":"0.03","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-12-01","end-date":"","notes":". Change of use and refurbishment of the Buregate Public House to accommodate 6 residential units with associated parking and landscape works","resource":"34a9e6604f4ffb616d5d36b4f19c21af3f4056cafd3473f5efd72d05b782ba34"},{"entry-date":"2017-12-01","organisation":"local-authority-eng:SUF","site":"SCDC008","site-address":"Land At Junction With Garrison Lane And High Road West Felixstowe Suffolk","site-plan-url":"http://waveney.maps.arcgis.com/apps/MapJournal/index.html?appid=1a787ff0d2604387987c86ac1ae56188","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"outline planning permission","hazardous-substances":"","latitude":"51.967572","longitude":"1.346948","hectares":"0.16","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-12-01","end-date":"","notes":"Built part of site only included; permitted area includes some greenfield land. Residential development of ten units, alterations to existing vehicular access associated external works and parking.","resource":"34a9e6604f4ffb616d5d36b4f19c21af3f4056cafd3473f5efd72d05b782ba34"},{"entry-date":"2017-12-01","organisation":"local-authority-eng:SUF","site":"SCDC009","site-address":"Former Civil Service Sports Ground Straight Road Foxhall Suffolk IP10 0BZ","site-plan-url":"http://waveney.maps.arcgis.com/apps/MapJournal/index.html?appid=1a787ff0d2604387987c86ac1ae56188","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.032778","longitude":"1.238382","hectares":"0.93","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-12-01","end-date":"","notes":". Proposed demolition of existing buildings and erection of 14 dwellings with associated vehicular access and external works.","resource":"34a9e6604f4ffb616d5d36b4f19c21af3f4056cafd3473f5efd72d05b782ba34"},{"entry-date":"2017-12-01","organisation":"local-authority-eng:SUF","site":"SCDC010","site-address":"Atlasfram Group Ltd New Road Framlingham Suffolk IP13 9AT","site-plan-url":"http://waveney.maps.arcgis.com/apps/MapJournal/index.html?appid=1a787ff0d2604387987c86ac1ae56188","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.223713","longitude":"1.339714","hectares":"0.45","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-12-01","end-date":"","notes":". Erection of 16 dwellings following the demolition of existing office buildings (resubmission of previously withdrawn application DC14/2573).","resource":"34a9e6604f4ffb616d5d36b4f19c21af3f4056cafd3473f5efd72d05b782ba34"},{"entry-date":"2017-12-01","organisation":"local-authority-eng:SUF","site":"SCDC011","site-address":"Conrad House 38 Fore Street Framlingham Woodbridge Suffolk IP13 9DF","site-plan-url":"http://waveney.maps.arcgis.com/apps/MapJournal/index.html?appid=1a787ff0d2604387987c86ac1ae56188","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.221677","longitude":"1.348407","hectares":"0.1","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-12-01","end-date":"","notes":". Demolition of side and front extension and outbuilding. Erection of side and rear extension to provide C3 residential accommodation. Subdivision of first floor to provide additional residential unit. Change of use ground floor B1 office to C3 residential","resource":"34a9e6604f4ffb616d5d36b4f19c21af3f4056cafd3473f5efd72d05b782ba34"},{"entry-date":"2017-12-01","organisation":"local-authority-eng:SUF","site":"SCDC012","site-address":"Glebe House Residential Home Rectory Road Hollesley Suffolk IP12 3JS","site-plan-url":"http://waveney.maps.arcgis.com/apps/MapJournal/index.html?appid=1a787ff0d2604387987c86ac1ae56188","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.051255","longitude":"1.437237","hectares":"0.97","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-12-01","end-date":"","notes":". Proposed erection of 9 dwellings; Change of use of managers accommodation to a single dwelling and creation of new access to Glebe House Residential Home.","resource":"34a9e6604f4ffb616d5d36b4f19c21af3f4056cafd3473f5efd72d05b782ba34"},{"entry-date":"2017-12-01","organisation":"local-authority-eng:SUF","site":"SCDC013","site-address":"Colonial House Station Road Leiston Suffolk IP16 4JD","site-plan-url":"http://waveney.maps.arcgis.com/apps/MapJournal/index.html?appid=1a787ff0d2604387987c86ac1ae56188","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.209182","longitude":"1.574036","hectares":"0.21","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-12-01","end-date":"","notes":". Change of Use of South Wing of Colonial House to form 10 flats with associated parking, bin store, cycle store","resource":"34a9e6604f4ffb616d5d36b4f19c21af3f4056cafd3473f5efd72d05b782ba34"},{"entry-date":"2017-12-01","organisation":"local-authority-eng:SUF","site":"SCDC014","site-address":"Abbey View Lodges Orchard House 105 Abbey Road Leiston Suffolk IP16 4TA","site-plan-url":"http://waveney.maps.arcgis.com/apps/MapJournal/index.html?appid=1a787ff0d2604387987c86ac1ae56188","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"outline planning permission","hazardous-substances":"","latitude":"52.217256","longitude":"1.576223","hectares":"0.51","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-12-01","end-date":"","notes":". Application for Outline Planning Permission with all matters reserved for redevelopment of the site for 10 dwellings.","resource":"34a9e6604f4ffb616d5d36b4f19c21af3f4056cafd3473f5efd72d05b782ba34"},{"entry-date":"2017-12-01","organisation":"local-authority-eng:SUF","site":"SCDC015","site-address":"Hillview Church Road Otley Suffolk IP6 9NP","site-plan-url":"http://waveney.maps.arcgis.com/apps/MapJournal/index.html?appid=1a787ff0d2604387987c86ac1ae56188","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"reserved matters approval","hazardous-substances":"","latitude":"52.150628","longitude":"1.218379","hectares":"2.14","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-12-01","end-date":"","notes":". Approval of Reserved Matters of DC/13/3229/OUT - Outline planning permission for redevelopment of site to include up to 35 dwellings, up to 900 square metres of B1 Commercial space, landscaping and  access roads. Existing buildings to be demolished.","resource":"34a9e6604f4ffb616d5d36b4f19c21af3f4056cafd3473f5efd72d05b782ba34"},{"entry-date":"2017-12-01","organisation":"local-authority-eng:SUF","site":"SCDC016","site-address":"Former County Primary School Fairfield Road Saxmundham Suffolk","site-plan-url":"http://waveney.maps.arcgis.com/apps/MapJournal/index.html?appid=1a787ff0d2604387987c86ac1ae56188","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"reserved matters approval","hazardous-substances":"","latitude":"52.216509","longitude":"1.486426","hectares":"0.59","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-12-01","end-date":"","notes":". Reserved matters (layout, appearance, scale and landscaping) for 16 dwellings.","resource":"34a9e6604f4ffb616d5d36b4f19c21af3f4056cafd3473f5efd72d05b782ba34"},{"entry-date":"2017-12-01","organisation":"local-authority-eng:SUF","site":"SCDC017","site-address":"Snape Maltings Snape Bridge Tunstall Suffolk","site-plan-url":"http://waveney.maps.arcgis.com/apps/MapJournal/index.html?appid=1a787ff0d2604387987c86ac1ae56188","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.163191","longitude":"1.49666","hectares":"1.47","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-12-01","end-date":"","notes":". Conversion of Maltings buildings into 43 residential units together with workshop/exhibition space at ground floor level and associated parking and landscaping","resource":"34a9e6604f4ffb616d5d36b4f19c21af3f4056cafd3473f5efd72d05b782ba34"},{"entry-date":"2017-12-01","organisation":"local-authority-eng:SUF","site":"SCDC018","site-address":"Fynn Valley Golf Club Rose Hill Witnesham Suffolk IP6 9JA","site-plan-url":"http://waveney.maps.arcgis.com/apps/MapJournal/index.html?appid=1a787ff0d2604387987c86ac1ae56188","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"52.097239","longitude":"1.183617","hectares":"2.13","minimum-net-dwellings":"0","maximum-net-dwellings":"0","start-date":"2017-12-01","end-date":"","notes":"Built part of site only included; permitted area includes some greenfield land. Erection of new clubhouse with associated facilities, conversion of existing buildings to form 10no. dwellings plus the section of 4no. new build dwellings.","resource":"34a9e6604f4ffb616d5d36b4f19c21af3f4056cafd3473f5efd72d05b782ba34"}]
</script>

<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-sidebar@0.2.2/src/L.Control.Sidebar.js" crossorigin=""></script>
<script src="https://unpkg.com/papaparse@5.1.1/papaparse.min.js" crossorigin=""></script>

<script>
var map = L.map('map', {
  preferCanvas: true,
  fullscreenControl: true
}).setView([52.561928, -1.464854], 7)

// Tile layers
L.tileLayer('https://tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
  id: 'base',
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map)

// Sidebar
var sidebar = L.control.sidebar('sidebar', {
  position: 'right'
})

map.addControl(sidebar)

// Brownfield Features
var brownfieldFeatures = brownfield.map(function (point) {
  return {
    type: 'Feature',
    geometry: {
      type: 'Point',
      coordinates: [point.longitude, point.latitude]
    },
    properties: point
  }
})

// Local authority boundaries (England only)
geoJson = geoJson.features.filter(function (item) {
  return item.properties.lad19cd.startsWith('E')
}).map(function (item) {
  var lad19cd = item.properties.lad19cd
  if (item.properties.lad19cd === 'E06000057') {
    // Northumberland
    lad19cd = 'E06000048'
  } else if (item.properties.lad19cd === 'E07000240') {
    // St Albans
    lad19cd = 'E07000100'
  } else if (item.properties.lad19cd === 'E07000241') {
    // Welwyn Hatfield
    lad19cd = 'E07000104'
  } else if (item.properties.lad19cd === 'E07000242') {
    // East Hertfordshire
    lad19cd = 'E07000097'
  } else if (item.properties.lad19cd === 'E07000243') {
    // Stevenage
    lad19cd = 'E07000101'
  } else if (item.properties.lad19cd === 'E08000037') {
    // Gateshead
    lad19cd = 'E08000020'
  }

  item.properties.organisation = organisations.find(function (organisation) {
    if (organisation['statistical-geography'] && organisation['statistical-geography'].length) {
      return organisation['statistical-geography'].toString().toLowerCase() === lad19cd.toString().toLowerCase()
    }
  })

  return item
})

L.geoJSON(geoJson, {
  style: {
    fillOpacity: 0,
    weight: 2,
    color: 'gray'
  },
  onEachFeature: function (feature, layer) {
    if(organisations.length === 1) {
      map.fitBounds(layer.getBounds())
    }

    if (!feature.properties.organisation) {
      layer.setStyle({
        fillColor: 'red',
        fillOpacity: 0.25
      })
    } else {
      var thisOrganisationsFeatures = brownfieldFeatures.filter(function (brownfieldFeature) {
        if (brownfieldFeature.properties.organisation.toLowerCase() === feature.properties.organisation.organisation.toLowerCase()) {
          return true
        }
        return false
      })

      var brownfieldMarkers = L.markerClusterGroup({
        showCoverageOnHover: false,
        zoomToBoundsOnClick: false,
        spiderfyOnMaxZoom: false,
        removeOutsideVisibleBounds: true,
        animate: false,
        disableClusteringAtZoom: 11,
        maxClusterRadius: 600,
        singleMarkerMode: false
      })
      var brownfieldOnMap = L.geoJSON({
        type: 'FeatureCollection',
        features: thisOrganisationsFeatures
      }, {
        pointToLayer: function (feature, latlng) {
          var size = isNaN(feature.properties.hectares) ? 100 : (Math.sqrt((feature.properties.hectares * 10000) / Math.PI))
          return L.circle(latlng, { color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: size.toFixed(2) })
        },
        onEachFeature: function (feature, layer) {
          layer.on({
            click: function () {
              sidebar.setContent('<h2>Loading...</h2>')
              sidebar.show()

              return Papa.parse('https://raw.githubusercontent.com/digital-land/map/master/docs/data/brownfield/' + feature.properties.organisation.toLowerCase().replace(':', '-') + '.csv', {
                download: true,
                header: true,
                complete: function (results) {
                  var point = results.data.find(function (row) {
                    return (row.latitude === feature.properties.latitude.toString()) && (row.longitude === feature.properties.longitude.toString())
                  })

                  if (point) {
                    content = ''

                    Object.keys(point).forEach(function (key) {
                      content = content + key + ': ' + point[key] + '<br>'
                    })
                  } else {
                    content = '<h2>Point not found - debug info:</h2><pre>' + JSON.stringify(results.data) + '</pre><h3>Looking for a row with latitude, longitude:</h3>' + feature.properties.latitude.toString() + ',' + feature.properties.longitude.toString()
                  }

                  sidebar.setContent(content)
                }
              })
            }
          })
        }
      })

      brownfieldMarkers.addLayer(brownfieldOnMap)
      map.addLayer(brownfieldMarkers)
    }

    layer.on({
      mouseover: function () {
        this.setStyle({
          fillColor: 'black',
          fillOpacity: 0.25
        })
      },
      mouseout: function () {
        this.setStyle({
          fillColor: 'white',
          fillOpacity: 0
        })
      },
      click: function () {
        return map.fitBounds(layer.getBounds())
      }
    })
  }
}).addTo(map)
</script>

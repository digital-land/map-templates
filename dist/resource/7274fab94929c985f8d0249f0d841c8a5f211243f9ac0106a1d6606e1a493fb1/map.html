<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.css" crossorigin="" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar@0.2.2/src/L.Control.Sidebar.css" crossorigin="" />

<style>
  body {
    margin: 0;
  }

  #map {
    width: 960px;
    height: 640px;
    transform: translate(-50%,-50%);
    position: absolute;
    top: 50%;
    left: 50%;
  }

  .leaflet-sidebar {
    display: none;
    width: 200px;
  }

  .leaflet-sidebar.visible {
    display: block;
  }

  .leaflet-sidebar .close {
    z-index: 10000;
  }

  .leaflet-marker-icon.marker-cluster {
    line-height: 18px;
    text-align: center;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    background: #fff;
    border: 2px solid #222;
  }
</style>

<div id="map"></div>
<div id="sidebar"></div>

<script>
  var geoJson = []
  var organisations = [{"organisation":"local-authority-eng:PUR","wikidata":"Q73072707","name":"Purbeck District Council","website":"https://www.dorsetforyou.com","twitter":"","statistical-geography":"E07000051","toid":"","opendatacommunities":"http://opendatacommunities.org/id/district-council/purbeck","opendatacommunities-area":"http://opendatacommunities.org/id/geography/administration/nmd/E07000051","billing-authority":"E1236","census-area":"19UG","local-authority-type":"NMD","esd-inventories":"","start-date":"","end-date":"2019-03-31"}]
  var brownfield = [{"entry-date":"2018-12-31","organisation":"local-authority-eng:PUR","site":"BR/03/001","site-address":"Former Bere Regis primary school, Rye Hill, Bere Regis","site-plan-url":"https://www.dorsetforyou.gov.uk/planning-buildings-land/planning-policy/purbeck/brownfield-register-purbeck/brownfield-register-purbeck.aspx","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"50.747808","longitude":"-2.218153","hectares":"0.3","minimum-net-dwellings":"9","maximum-net-dwellings":"9","start-date":"2017-12-31","end-date":"","notes":"Only part of site brownfield - school building SHLAA 6/03/1336","resource":"7274fab94929c985f8d0249f0d841c8a5f211243f9ac0106a1d6606e1a493fb1"},{"entry-date":"2018-12-31","organisation":"local-authority-eng:PUR","site":"BR/11/002","site-address":"Binnegar Hall, East Stoke, Wareham","site-plan-url":"https://www.dorsetforyou.gov.uk/planning-buildings-land/planning-policy/purbeck/brownfield-register-purbeck/brownfield-register-purbeck.aspx","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"50.683987","longitude":"-2.165649","hectares":"1.66","minimum-net-dwellings":"50","maximum-net-dwellings":"50","start-date":"2017-12-31","end-date":"","notes":"SHLAA 6/11/1337. \"Alterations, extensions and changes of use of existing buildings to Class C3 residential use - 23 dwellings - 9 houses and 14 flats/maisonettes\"","resource":"7274fab94929c985f8d0249f0d841c8a5f211243f9ac0106a1d6606e1a493fb1"},{"entry-date":"2018-12-31","organisation":"local-authority-eng:PUR","site":"BR/11/003","site-address":"Kemps Country House Hotel, East Stoke, Wareham","site-plan-url":"https://www.dorsetforyou.gov.uk/planning-buildings-land/planning-policy/purbeck/brownfield-register-purbeck/brownfield-register-purbeck.aspx","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"50.683471","longitude":"-2.171199","hectares":"0.1","minimum-net-dwellings":"6","maximum-net-dwellings":"6","start-date":"2017-12-31","end-date":"","notes":"Other application number 6/2015/0005. \"Change of use of Kemps Country House to 6 dwellings with associated alteration works, extension to the coach house, parking and landscaping.\"","resource":"7274fab94929c985f8d0249f0d841c8a5f211243f9ac0106a1d6606e1a493fb1"},{"entry-date":"2018-12-31","organisation":"local-authority-eng:PUR","site":"BR/15/004","site-address":"Bere Farm, Lytchett Minster","site-plan-url":"https://www.dorsetforyou.gov.uk/planning-buildings-land/planning-policy/purbeck/brownfield-register-purbeck/brownfield-register-purbeck.aspx","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"50.740534","longitude":"-2.083202","hectares":"0.51","minimum-net-dwellings":"15","maximum-net-dwellings":"15","start-date":"2017-12-31","end-date":"","notes":"SHLAA 6/15/1373","resource":"7274fab94929c985f8d0249f0d841c8a5f211243f9ac0106a1d6606e1a493fb1"},{"entry-date":"2018-12-31","organisation":"local-authority-eng:PUR","site":"BR/20/006","site-address":"Former Police Station Premises, Argyle Road and Kings Road West, Swanage","site-plan-url":"https://www.dorsetforyou.gov.uk/planning-buildings-land/planning-policy/purbeck/brownfield-register-purbeck/brownfield-register-purbeck.aspx","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"50.609202","longitude":"-1.964994","hectares":"0.03","minimum-net-dwellings":"6","maximum-net-dwellings":"6","start-date":"2017-12-31","end-date":"","notes":". Alterations and extensions to former police station to facilitate conversion to 6 dwellings","resource":"7274fab94929c985f8d0249f0d841c8a5f211243f9ac0106a1d6606e1a493fb1"},{"entry-date":"2018-12-31","organisation":"local-authority-eng:PUR","site":"BR/20/007","site-address":"Cauldron Barn caravan site, Swanage","site-plan-url":"https://www.dorsetforyou.gov.uk/planning-buildings-land/planning-policy/purbeck/brownfield-register-purbeck/brownfield-register-purbeck.aspx","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"50.616507","longitude":"-1.966571","hectares":"0.39","minimum-net-dwellings":"6","maximum-net-dwellings":"6","start-date":"2017-12-31","end-date":"","notes":"SHLAA 6/20/1332","resource":"7274fab94929c985f8d0249f0d841c8a5f211243f9ac0106a1d6606e1a493fb1"},{"entry-date":"2018-12-31","organisation":"local-authority-eng:PUR","site":"BR/20/008","site-address":"former grammar school, Northbrook Road, Swanage","site-plan-url":"https://www.dorsetforyou.gov.uk/planning-buildings-land/planning-policy/purbeck/brownfield-register-purbeck/brownfield-register-purbeck.aspx","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"50.620479","longitude":"-1.964128","hectares":"0.93","minimum-net-dwellings":"40","maximum-net-dwellings":"40","start-date":"2017-12-31","end-date":"","notes":"Only part of the former school site is brownfield -the majority is that which was orginally set aside as a site for Swanage School.","resource":"7274fab94929c985f8d0249f0d841c8a5f211243f9ac0106a1d6606e1a493fb1"},{"entry-date":"2018-12-31","organisation":"local-authority-eng:PUR","site":"BR/20/009","site-address":"1 The Pier Head, High St, Swanage","site-plan-url":"https://www.dorsetforyou.gov.uk/planning-buildings-land/planning-policy/purbeck/brownfield-register-purbeck/brownfield-register-purbeck.aspx","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"permissioned","planning-permission-type":"full planning permission","hazardous-substances":"","latitude":"50.607528","longitude":"-1.953617","hectares":"0.16","minimum-net-dwellings":"8","maximum-net-dwellings":"8","start-date":"2017-12-31","end-date":"","notes":"Other application numbers 6/2014/0166|6/2011/0812. \"Demolition Pier Head Building and associated out buildings, erect two new buildings to form eight flats, restaurant, pizza oven, ice cream parlour and gallery.  Landscape site and form new vehicular parking in basement\"","resource":"7274fab94929c985f8d0249f0d841c8a5f211243f9ac0106a1d6606e1a493fb1"},{"entry-date":"2018-12-31","organisation":"local-authority-eng:PUR","site":"BR/23/011","site-address":"'Former Gas Works Site, Wareham''","site-plan-url":"https://www.dorsetforyou.gov.uk/planning-buildings-land/planning-policy/purbeck/brownfield-register-purbeck/brownfield-register-purbeck.aspx","deliverable":"yes","ownership":"not owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"50.68836","longitude":"-2.109799","hectares":"0.3","minimum-net-dwellings":"10","maximum-net-dwellings":"10","start-date":"2018-12-31","end-date":"","notes":"Allocated in Wareham Neighbourhood Plan for residential development","resource":"7274fab94929c985f8d0249f0d841c8a5f211243f9ac0106a1d6606e1a493fb1"},{"entry-date":"2018-12-31","organisation":"local-authority-eng:PUR","site":"BR/23/012","site-address":"'Former Wareham Middle School, Wareham''","site-plan-url":"https://www.dorsetforyou.gov.uk/planning-buildings-land/planning-policy/purbeck/brownfield-register-purbeck/brownfield-register-purbeck.aspx","deliverable":"yes","ownership":"owned by a public authority","planning-permission-status":"not permissioned","planning-permission-type":"","hazardous-substances":"","latitude":"50.684754","longitude":"-2.118567","hectares":"1.2","minimum-net-dwellings":"35","maximum-net-dwellings":"35","start-date":"2018-12-31","end-date":"","notes":"Allocated in Wareham Neighbourhood Plan for residential development","resource":"7274fab94929c985f8d0249f0d841c8a5f211243f9ac0106a1d6606e1a493fb1"}]
</script>

<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-sidebar@0.2.2/src/L.Control.Sidebar.js" crossorigin=""></script>
<script src="https://unpkg.com/papaparse@5.1.1/papaparse.min.js" crossorigin=""></script>

<script>
var map = L.map('map', {
  preferCanvas: true,
  fullscreenControl: true
}).setView([52.561928, -1.464854], 7)

// Tile layers
L.tileLayer('https://tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
  id: 'base',
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map)

// Sidebar
var sidebar = L.control.sidebar('sidebar', {
  position: 'right'
})

map.addControl(sidebar)

// Brownfield Features
var brownfieldFeatures = brownfield.map(function (point) {
  return {
    type: 'Feature',
    geometry: {
      type: 'Point',
      coordinates: [point.longitude, point.latitude]
    },
    properties: point
  }
})

// Local authority boundaries (England only)
geoJson = geoJson.features.filter(function (item) {
  return item.properties.lad19cd.startsWith('E')
}).map(function (item) {
  var lad19cd = item.properties.lad19cd
  if (item.properties.lad19cd === 'E06000057') {
    // Northumberland
    lad19cd = 'E06000048'
  } else if (item.properties.lad19cd === 'E07000240') {
    // St Albans
    lad19cd = 'E07000100'
  } else if (item.properties.lad19cd === 'E07000241') {
    // Welwyn Hatfield
    lad19cd = 'E07000104'
  } else if (item.properties.lad19cd === 'E07000242') {
    // East Hertfordshire
    lad19cd = 'E07000097'
  } else if (item.properties.lad19cd === 'E07000243') {
    // Stevenage
    lad19cd = 'E07000101'
  } else if (item.properties.lad19cd === 'E08000037') {
    // Gateshead
    lad19cd = 'E08000020'
  }

  item.properties.organisation = organisations.find(function (organisation) {
    if (organisation['statistical-geography'] && organisation['statistical-geography'].length) {
      return organisation['statistical-geography'].toString().toLowerCase() === lad19cd.toString().toLowerCase()
    }
  })

  return item
})

L.geoJSON(geoJson, {
  style: {
    fillOpacity: 0,
    weight: 2,
    color: 'gray'
  },
  onEachFeature: function (feature, layer) {
    if(organisations.length === 1) {
      map.fitBounds(layer.getBounds())
    }

    if (!feature.properties.organisation) {
      layer.setStyle({
        fillColor: 'red',
        fillOpacity: 0.25
      })
    } else {
      var thisOrganisationsFeatures = brownfieldFeatures.filter(function (brownfieldFeature) {
        if (brownfieldFeature.properties.organisation.toLowerCase() === feature.properties.organisation.organisation.toLowerCase()) {
          return true
        }
        return false
      })

      var brownfieldMarkers = L.markerClusterGroup({
        showCoverageOnHover: false,
        zoomToBoundsOnClick: false,
        spiderfyOnMaxZoom: false,
        removeOutsideVisibleBounds: true,
        animate: false,
        disableClusteringAtZoom: 11,
        maxClusterRadius: 600,
        singleMarkerMode: false
      })
      var brownfieldOnMap = L.geoJSON({
        type: 'FeatureCollection',
        features: thisOrganisationsFeatures
      }, {
        pointToLayer: function (feature, latlng) {
          var size = isNaN(feature.properties.hectares) ? 100 : (Math.sqrt((feature.properties.hectares * 10000) / Math.PI))
          return L.circle(latlng, { color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: size.toFixed(2) })
        },
        onEachFeature: function (feature, layer) {
          layer.on({
            click: function () {
              sidebar.setContent('<h2>Loading...</h2>')
              sidebar.show()

              return Papa.parse('https://raw.githubusercontent.com/digital-land/map/master/docs/data/brownfield/' + feature.properties.organisation.toLowerCase().replace(':', '-') + '.csv', {
                download: true,
                header: true,
                complete: function (results) {
                  var point = results.data.find(function (row) {
                    return (row.latitude === feature.properties.latitude.toString()) && (row.longitude === feature.properties.longitude.toString())
                  })

                  if (point) {
                    content = ''

                    Object.keys(point).forEach(function (key) {
                      content = content + key + ': ' + point[key] + '<br>'
                    })
                  } else {
                    content = '<h2>Point not found - debug info:</h2><pre>' + JSON.stringify(results.data) + '</pre><h3>Looking for a row with latitude, longitude:</h3>' + feature.properties.latitude.toString() + ',' + feature.properties.longitude.toString()
                  }

                  sidebar.setContent(content)
                }
              })
            }
          })
        }
      })

      brownfieldMarkers.addLayer(brownfieldOnMap)
      map.addLayer(brownfieldMarkers)
    }

    layer.on({
      mouseover: function () {
        this.setStyle({
          fillColor: 'black',
          fillOpacity: 0.25
        })
      },
      mouseout: function () {
        this.setStyle({
          fillColor: 'white',
          fillOpacity: 0
        })
      },
      click: function () {
        return map.fitBounds(layer.getBounds())
      }
    })
  }
}).addTo(map)
</script>
